<template>
  <div :aria-hidden="true" class="payment-animated" ref="root">
    <svg
      ref="svgRoot"
      xmlns="http://www.w3.org/2000/svg"
      xmlns:xlink="http://www.w3.org/1999/xlink"
      viewBox="0 0 512 512"
      width="512" height="512"
      preserveAspectRatio="xMidYMid meet"
      style="width:100%;height:100%;background:transparent;display:block;"
    >
      <defs>
        <clipPath id="__lottie_element_22"><rect width="512" height="512" x="0" y="0"></rect></clipPath>
      </defs>

      <g clip-path="url(#__lottie_element_22)">

        <!-- большая фома (движение + вращение) -->
        <g id="g_main_left"
           transform="matrix(1,0,0,1,54.76202392578125,164.43899536132812)"
           opacity="1" style="display:block;">
          <g opacity="1" transform="matrix(1,0,0,1,220.85400390625,129.1739959716797)">
            <path fill="rgb(81,18,215)" fill-opacity="1" d=" M177.03900146484375,128.9250030517578 C177.03900146484375,128.9250030517578 -177.03799438476562,128.9250030517578 -177.03799438476562,128.9250030517578 C-201.0989990234375,128.9250030517578 -220.60400390625,109.41999816894531 -220.60400390625,85.36000061035156 C-220.60400390625,85.36000061035156 -220.60400390625,-85.35900115966797 -220.60400390625,-85.35900115966797 C-220.60400390625,-109.41899871826172 -201.0989990234375,-128.9239959716797 -177.03799438476562,-128.9239959716797 C-177.03799438476562,-128.9239959716797 177.03900146484375,-128.9239959716797 177.03900146484375,-128.9239959716797 C201.10000610351562,-128.9239959716797 220.60499572753906,-109.41899871826172 220.60499572753906,-85.35900115966797 C220.60499572753906,-85.35900115966797 220.60400390625,85.36000061035156 220.60400390625,85.36000061035156 C220.60400390625,109.41999816894531 201.10000610351562,128.9250030517578 177.03900146484375,128.9250030517578z"></path>
          </g>
        </g>

        <!-- белая внутренняя форма -->
        <g id="g_inner_white"
           transform="matrix(1,0,0,1,86.09302520751953,190.80599975585938)"
           opacity="1" style="display:block;">
          <g opacity="1" transform="matrix(1,0,0,1,61.165000915527344,25.02899932861328)">
            <path fill="rgb(255,255,255)" fill-opacity="1" d=" M47.30799865722656,24.77899932861328 C47.30799865722656,24.77899932861328 -47.30799865722656,24.77899932861328 -47.30799865722656,24.77899932861328 C-54.821998596191406,24.77899932861328 -60.915000915527344,18.687000274658203 -60.915000915527344,11.17199993133545 C-60.915000915527344,11.17199993133545 -60.915000915527344,-11.17199993133545 -60.915000915527344,-11.17199993133545 C-60.915000915527344,-18.687000274658203 -54.821998596191406,-24.77899932861328 -47.30799865722656,-24.77899932861328 C-47.30799865722656,-24.77899932861328 47.30799865722656,-24.77899932861328 47.30799865722656,-24.77899932861328 C54.823001861572266,-24.77899932861328 60.915000915527344,-18.687000274658203 60.915000915527344,-11.17199993133545 C60.915000915527344,-11.17199993133545 60.915000915527344,11.17199993133545 60.915000915527344,11.17199993133545 C60.915000915527344,18.687000274658203 54.823001861572266,24.77899932861328 47.30799865722656,24.77899932861328z"></path>
          </g>
        </g>

        <!-- фоновая фиолетовая форма (статичная) -->
        <g transform="matrix(1,0,0,1,57.675994873046875,197.90199279785156)" opacity="1" style="display:block;">
          <g opacity="1" transform="matrix(1,0,0,1,220.85400390625,129.1739959716797)">
            <path fill="rgb(156,115,246)" fill-opacity="1" d=" M177.03900146484375,128.9239959716797 C177.03900146484375,128.9239959716797 -177.03900146484375,128.92300415039062 -177.03900146484375,128.92300415039062 C-201.0989990234375,128.92300415039062 -220.60400390625,109.41799926757812 -220.60400390625,85.35800170898438 C-220.60400390625,85.35800170898438 -220.60400390625,-85.35900115966797 -220.60400390625,-85.35900115966797 C-220.60400390625,-109.41899871826172 -201.0989990234375,-128.9239959716797 -177.03799438476562,-128.9239959716797 C-177.03799438476562,-128.9239959716797 177.03900146484375,-128.9239959716797 177.03900146484375,-128.9239959716797 C201.10000610351562,-128.9239959716797 220.60400390625,-109.41899871826172 220.60400390625,-85.35800170898438 C220.60400390625,-85.35800170898438 220.60400390625,85.35900115966797 220.60400390625,85.35900115966797 C220.60400390625,109.41899871826172 201.10000610351562,128.9239959716797 177.03900146484375,128.9239959716797z"></path>
          </g>
        </g>

        <!-- маленькие кружки: теперь с корректными id и матрицами из первого фрейма -->
        <!-- кружок A (цвет 95,52,186) -->
        <g id="g_dot_a"
           transform="matrix(1,0,0,1,319.98199462890625,337.7619934082031)"
           opacity="1" style="display:block;">
          <g opacity="1" transform="matrix(1,0,0,1,38.32699966430664,38.32699966430664)">
            <path fill="rgb(95,52,186)" fill-opacity="1" d=" M37.86600112915039,0.382999986410141 C37.654998779296875,21.29599952697754 20.530000686645508,38.07699966430664 -0.382999986410141,37.86600112915039 C-21.295000076293945,37.654998779296875 -38.07699966430664,20.530000686645508 -37.86600112915039,-0.38199999928474426 C-37.654998779296875,-21.295000076293945 -20.530000686645508,-38.07699966430664 0.382999986410141,-37.8650016784668 C21.295000076293945,-37.65399932861328 38.07699966430664,-20.530000686645508 37.86600112915039,0.382999986410141z"></path>
          </g>
        </g>

        <!-- кружок B (цвет 81,18,215) -->
        <g id="g_dot_b"
           transform="matrix(1,0,0,1,376.781005859375,338.33599853515625)"
           opacity="1" style="display:block;">
          <g opacity="1" transform="matrix(1,0,0,1,38.32699966430664,38.32699966430664)">
            <path fill="rgb(81,18,215)" fill-opacity="1" d=" M-37.86600112915039,-0.382999986410141 C-38.07699966430664,20.530000686645508 -21.295000076293945,37.65399932861328 -0.382999986410141,37.8650016784668 C20.530000686645508,38.07699966430664 37.654998779296875,21.295000076293945 37.8650016784668,0.38199999928474426 C38.07699966430664,-20.530000686645508 21.295000076293945,-37.654998779296875 0.382999986410141,-37.86600112915039 C-20.5310001373291,-38.07699966430664 -37.654998779296875,-21.29599952697754 -37.86600112915039,-0.382999986410141z"></path>
          </g>
        </g>

        <!-- нижняя полоса (статична) -->
        <g transform="matrix(1,0,0,1,58.31298828125,241.26498413085938)" opacity="1" style="display:block;">
          <g opacity="1" transform="matrix(1,0,0,1,219.87600708007812,24.878999710083008)">
            <path fill="rgb(45,45,45)" fill-opacity="1" d=" M219.62600708007812,24.628000259399414 C219.62600708007812,24.628000259399414 -219.62600708007812,24.628000259399414 -219.62600708007812,24.628000259399414 C-219.62600708007812,24.628000259399414 -219.625,-24.628000259399414 -219.625,-24.628000259399414 C-219.625,-24.628000259399414 219.62600708007812,-24.628000259399414 219.62600708007812,-24.628000259399414 C219.62600708007812,-24.628000259399414 219.62600708007812,24.628000259399414 219.62600708007812,24.628000259399414z"></path>
          </g>
        </g>

      </g>
    </svg>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted } from 'vue'

/**
 * Обновлённый PaymentAnimated.vue
 * Анимация: бесконечный ping-pong (туда/обратно).
 * Точные матрицы взяты из первого и последнего фреймов, которые вы прислали.
 */

const props = defineProps({
  duration: { type: Number, default: 1100 },
  autoplay: { type: Boolean, default: true },
  loop: { type: Boolean, default: true },
  pingpong: { type: Boolean, default: true },
  delay: { type: Number, default: 0 }
})

const svgRoot = ref(null)
let rafId = null
let timeoutId = null
let destroyed = false

onUnmounted(() => {
  destroyed = true
  if (rafId) cancelAnimationFrame(rafId)
  if (timeoutId) clearTimeout(timeoutId)
})

onMounted(() => {
  const root = svgRoot.value
  const q = id => root?.querySelector(`#${id}`)

  // targets: from (first frame) -> to (last frame)
  const targets = [
    // основная форма (matrix rotation+translate)
    {
      id: 'g_main_left',
      el: q('g_main_left'),
      from: [1,0,0,1,54.76202392578125,164.43899536132812],
      to:   [0.9093958139419556,0.4159318208694458,-0.4159318208694458,0.9093958139419556,110.55703735351562,3.8417816162109375]
    },
    // белая внутренняя форма
    {
      id: 'g_inner_white',
      el: q('g_inner_white'),
      from: [1,0,0,1,86.09302520751953,190.80599975585938],
      to:   [0.9093958139419556,0.4159318208694458,-0.4159318208694458,0.9093958139419556,128.0824432373047,40.851383209228516]
    },
    // кружок A (перемещается справа -> вправо)
    {
      id: 'g_dot_a',
      el: q('g_dot_a'),
      from: [1,0,0,1,319.98199462890625,337.7619934082031],
      to:   [1,0,0,1,374.7802734375,338.3525390625]
    },
    // кружок B (перемещается слева -> влево)
    {
      id: 'g_dot_b',
      el: q('g_dot_b'),
      from: [1,0,0,1,376.781005859375,338.33599853515625],
      to:   [1,0,0,1,321.9657287597656,337.7957458496094]
    }
  ].filter(t => t.el) // оставляем только найденные элементы

  if (!targets.length) {
    console.warn('[PaymentAnimated] Не найдены целевые группы внутри SVG (id mismatch).')
    return
  }

  // reduced motion
  const reduce = typeof window !== 'undefined' && window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches
  const duration = reduce ? 0 : Math.max(0, props.duration)

  // easing
  function easeInOutCubic(t) {
    return t < 0.5 ? 4*t*t*t : 1 - Math.pow(-2*t + 2, 3) / 2;
  }
  const lerp = (a,b,t) => a + (b - a) * t

  // установка начальных матриц явно
  targets.forEach(t => {
    t.el.setAttribute('transform', 'matrix(' + t.from.map(n => +n.toFixed(6)).join(',') + ')')
  })

  if (!props.autoplay || duration === 0) {
    // если reduced-motion или autoplay=false — не запускаем (при reduced-motion оставляем начальное)
    if (props.autoplay && duration === 0) {
      // если autoplay и reduced-motion: ставим финальное мгновенно (можно менять по желанию)
      targets.forEach(t => {
        t.el.setAttribute('transform', 'matrix(' + t.to.map(n => +n.toFixed(6)).join(',') + ')')
      })
    }
    return
  }

  // animation loop (pingpong + loop)
  let direction = 1 // 1 forward, -1 backward
  let startTime = null

  function step(now) {
    if (destroyed) return
    if (!startTime) startTime = now
    const elapsed = now - startTime
    const tRaw = Math.min(1, elapsed / duration)
    const eased = easeInOutCubic(tRaw)
    const prog = direction === 1 ? eased : 1 - eased

    targets.forEach(t => {
      const vals = t.from.map((v,i) => lerp(v, t.to[i], prog))
      t.el.setAttribute('transform', 'matrix(' + vals.map(n => +n.toFixed(6)).join(',') + ')')
    })

    if (tRaw < 1) {
      rafId = requestAnimationFrame(step)
      return
    }

    // leg finished
    if (props.pingpong) {
      direction *= -1
      startTime = null
      // если loop — продолжаем вечно (reverse direction toggles)
      if (props.loop) {
        rafId = requestAnimationFrame(step)
      } else {
        // если не loop но pingpong: пройдёт туда и обратно один раз
        if (direction === -1) {
          rafId = requestAnimationFrame(step)
        } else {
          // вернулись в начальное — остановимся
          targets.forEach(t => {
            t.el.setAttribute('transform', 'matrix(' + t.from.map(n => +n.toFixed(6)).join(',') + ')')
          })
        }
      }
    } else {
      // без pingpong
      if (props.loop) {
        // restart forward
        direction = 1
        startTime = null
        rafId = requestAnimationFrame(step)
      } else {
        // one-shot forward
        targets.forEach(t => {
          t.el.setAttribute('transform', 'matrix(' + t.to.map(n => +n.toFixed(6)).join(',') + ')')
        })
      }
    }
  }

  // старт после delay
  if (props.delay > 0) {
    timeoutId = setTimeout(() => {
      if (!destroyed) rafId = requestAnimationFrame(step)
    }, props.delay)
  } else {
    rafId = requestAnimationFrame(step)
  }
})
</script>

<style scoped>
.payment-animated {
  display: inline-block;
  line-height: 0;
      width: 85%;
}
</style>
