import{h as f,A as w}from"./D_JQTfwH.js";function y(t={}){const s=Object.entries(t).filter(([,e])=>e!=null&&e!=="").map(([e,i])=>`${encodeURIComponent(e)}=${encodeURIComponent(i)}`).join("&");return s?`?${s}`:""}const T=f("template",{state:()=>({loading:!1,error:null,templates:[],current:null,total:0,page:1,perPage:20,nextCursor:null,hasMore:!0,testResult:null}),getters:{isLoading:t=>t.loading,hasError:t=>!!t.error,templatesCount:t=>t.templates.length,canLoadMore:t=>t.hasMore,currentTemplate:t=>t.current},actions:{async _request({method:t="GET",path:s="",params:e=null,body:i=null}={}){this.loading=!0,this.error=null;try{const n=e?y(e):"",p=`${w.fullUrl}/template${s}${n}`,u={method:t,headers:{}};i&&(t==="POST"||t==="PUT"||t==="PATCH")&&(u.headers["Content-Type"]="application/json",u.body=JSON.stringify(i));const a=await fetch(p,u);let r=null;try{r=await a.json()}catch{if(!a.ok)throw new Error(a.statusText||"Network error");return null}if(!a.ok){const o=r&&(r.description||r.data)?r.description||r.data:a.statusText||`HTTP ${a.status}`;throw new Error(o)}if(r&&typeof r=="object"&&"status"in r){if(String(r.status)==="200")return r.data;const o=r.description||r.data||"Server error";throw new Error(o)}return r}catch(n){throw this.error=n.message||String(n),n}finally{this.loading=!1}},async test(){const t=await this._request({method:"GET",path:"/test"});return this.testResult=t,t},async createTemplate(t){const s=await this._request({method:"POST",path:"/",body:t});return s&&s.id&&(this.templates.unshift(s),this.total=Number(this.total||0)+1),s},async getTemplateById(t){if(!t)throw new Error("id is required");const s=await this._request({method:"GET",path:`/${encodeURIComponent(t)}`});return this.current=s,s},async getTemplateByUid(t){if(!t)throw new Error("uid is required");const s=await this._request({method:"GET",path:`/uid/${encodeURIComponent(t)}`});return this.current=s,s},async updateTemplate(t,s){if(!t)throw new Error("id is required");const e=await this._request({method:"PUT",path:`/${encodeURIComponent(t)}`,body:s});if(e){const i=this.templates.findIndex(n=>n.id===e.id);i!==-1&&this.templates.splice(i,1,e),this.current&&this.current.id===e.id&&(this.current=e)}return e},async deleteTemplate(t){if(!t)throw new Error("id is required");const s=await this._request({method:"DELETE",path:`/${encodeURIComponent(t)}`}),e=this.templates.findIndex(i=>i.id===Number(t));return e!==-1&&(this.templates.splice(e,1),this.total=Math.max(0,Number(this.total||0)-1)),this.current&&this.current.id===Number(t)&&(this.current=null),s},async listTemplates({page:t=1,perPage:s=20,filters:e={},append:i=!1,sortBy:n="have_html,popular,created_at",order:p="desc"}={}){const u={page:t,perPage:s,type:e.type,popular:typeof e.popular<"u"?e.popular?"1":"0":void 0,min_price:e.min_price,max_price:e.max_price,search:e.search,uid:e.uid,sort_by:n,order:p},a=await this._request({method:"GET",path:"/",params:u});let r=[],o=0,c=t,d=s;if(Array.isArray(a))r=a,o=a.length;else if(a&&typeof a=="object")if(Array.isArray(a.rows))r=a.rows,o=Number(a.total??r.length),c=Number(a.page??t),d=Number(a.perPage??s);else if(a.data&&typeof a.data=="object"){const l=a.data;Array.isArray(l.rows)?(r=l.rows,o=Number(l.total??r.length),c=Number(l.page??t),d=Number(l.perPage??s)):Array.isArray(l)&&(r=l,o=l.length)}else{const l=Object.values(a).find(h=>Array.isArray(h));l&&(r=l,o=Number(a.total??r.length))}if(i){const l=new Set(this.templates.map(m=>m.id)),h=r.filter(m=>!l.has(m.id));this.templates=this.templates.concat(h)}else this.templates=r;return this.total=Number(o||0),this.page=c,this.perPage=d,this.hasMore=this.templates.length<this.total,this.nextCursor=null,a},async loadMoreOffset({filters:t={},sortBy:s="have_html,popular,created_at",order:e="desc"}={}){if(this.loading||!this.hasMore)return;const i=(Number(this.page)||1)+1;try{await this.listTemplates({page:i,perPage:this.perPage,filters:t,append:!0,sortBy:s,order:e})}catch(n){console.warn("[template.store] loadMoreOffset failed",n)}},async listTemplatesInfinite({limit:t=20,lastCreatedAt:s=null,lastId:e=null,order:i="desc",filters:n={},lastHaveHtml:p=void 0,lastPopular:u=void 0}={}){const a={limit:t,lastCreatedAt:s,lastId:e,order:i,lastHaveHtml:typeof p<"u"?p?"1":"0":void 0,lastPopular:typeof u<"u"?u?"1":"0":void 0,type:n.type,popular:typeof n.popular<"u"?n.popular?"1":"0":void 0,min_price:n.min_price,max_price:n.max_price,search:n.search,uid:n.uid},r=await this._request({method:"GET",path:"/infinite",params:a}),o=r&&Array.isArray(r.rows)?r.rows:[],c=r&&r.nextCursor?r.nextCursor:null;if(!s&&!e)this.templates=o;else{const d=new Set(this.templates.map(h=>h.id)),l=o.filter(h=>!d.has(h.id));this.templates=this.templates.concat(l)}return this.nextCursor=c,this.hasMore=!!c&&o.length>0,r},async searchByTitle(t,s=20){if(!t)throw new Error("query q is required");const e={q:t,limit:s};return await this._request({method:"GET",path:"/search/title",params:e})},clearError(){this.error=null},reset(){this.loading=!1,this.error=null,this.templates=[],this.current=null,this.total=0,this.page=1,this.perPage=20,this.nextCursor=null,this.hasMore=!0,this.testResult=null}}});export{T as u};
