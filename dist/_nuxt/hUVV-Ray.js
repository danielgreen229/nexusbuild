import{f as Pe,A as Ae,_ as Ne,s as Ce,q as ke,p as xe,P as De,i as N,j as Se,y as l,z as K,c as m,o as f,a as s,b as se,t as i,h as ae,H as Me,g as C,v as Ue,C as O,K as Te,F as Be,d as D,Q as $e,G as Re}from"./xo8e5jVH.js";import{u as Ee}from"./WZmaIR9D.js";import{u as ze}from"./DZg870Wl.js";import{D as Le}from"./D1-95J6M.js";const re=`${Ae.fullUrl}/promocode`,qe=Pe("promocodes",{state:()=>({loading:!1,error:null,lastApplied:null,preview:null}),actions:{clearError(){this.error=null},reset(){this.loading=!1,this.error=null,this.lastApplied=null,this.preview=null},_extractData(p){return p?p.data??p:null},async getPromoByCode(p){this.loading=!0,this.error=null;try{if(!p)return{success:!1,message:"code is required",data:null};const c=await fetch(`${re}/by-code/${encodeURIComponent(p)}`,{method:"GET",headers:{Accept:"application/json"}}),w=await c.json().catch(()=>null),d=this._extractData(w);if(!c.ok){const n=d&&(d.message||d.error)||`HTTP ${c.status}`;return this.error=n,{success:!1,message:d.data,data:null}}return{success:!0,data:d}}catch(c){return console.error("getPromoByCode error",c),this.error=c.message||"Network error",{success:!1,message:this.error,data:null}}finally{this.loading=!1}},calculateDiscountLocal(p,c){if(!p)return{discount:0,finalAmount:Number(c)};const w=(p.discount_type||"").toLowerCase(),d=Number(p.discount_value||0);let n=0;w==="percent"?n=Number(c)*d/100:n=d,n>Number(c)&&(n=Number(c)),n=Math.round(n*100)/100;const a=Math.round((Number(c)-n)*100)/100;return{discount:n,finalAmount:a}},async previewPromocode(p,c,w="RUB"){this.loading=!0,this.error=null,this.preview=null;try{if(!p||typeof c>"u"){const y="code и orderAmount обязательны";return this.error=y,{success:!1,message:y,data:null}}const d=await this.getPromoByCode(p);if(!d.success)return{success:!1,message:d.message||"Промокод не найден",data:null};const n=d.data;if(Number(c)<Number(n.minimum_order_amount||0)){const y=`Минимальная сумма заказа ${n.minimum_order_amount||0}`;return this.preview=n,this.error=y,{success:!1,message:y,data:n}}const{discount:a,finalAmount:P}=this.calculateDiscountLocal(n,c);return this.preview={...n,discount:a,finalAmount:P},{success:!0,data:this.preview,discount:a,finalAmount:P}}catch(d){return console.error("previewPromocode error",d),this.error=d.message||"Ошибка превью",{success:!1,message:this.error,data:null}}finally{this.loading=!1}},async applyPromocode({code:p,uid:c,orderAmount:w,currency:d="USD",orderId:n=null}){this.loading=!0,this.error=null;try{if(!p||!c||typeof w>"u"){const k="Обязательные поля: code, uid, orderAmount";return this.error=k,{success:!1,message:k,data:null}}const a={code:p,uid:c,orderAmount:w,currency:d,orderId:n},P=await fetch(`${re}/redeem`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(a)}),y=await P.json().catch(()=>null),g=this._extractData(y);if(!P.ok){const k=g&&(g.message||g.error)||`HTTP ${P.status}`;return this.error=k,{success:!1,message:k,data:null}}const U={...g||{},code:g&&g.code?g.code:p};return this.lastApplied=U,{success:!0,data:U}}catch(a){return console.error("applyPromocode error",a),this.error=a.message||"Ошибка при применении промокода",{success:!1,message:this.error,data:null}}finally{this.loading=!1}}}}),Fe={class:"buy__container"},je={class:"wrapper"},Ie={class:"card card__container"},Ve={class:"card__left"},He={class:"title"},Ke={class:"extras"},Oe={class:"addon custom-switch"},We={class:"label-text"},Ge={class:"domain__container"},Je={class:"domain-scroll__container"},Qe={class:"card__right"},Xe={class:"meta"},Ye={class:"price"},Ze={class:"card sidebar"},et={class:"order-lines"},tt={class:"line"},st={key:0,class:"line"},at={key:1,class:"line"},rt={key:2,class:"line"},nt={class:"line"},ot={class:"line",style:{"flex-direction":"column","align-items":"stretch",gap:"0.5rem","padding-top":"0.5rem"}},lt={style:{display:"flex",gap:"0.5rem","align-items":"center"}},it=["disabled"],ut=["disabled"],ct={key:0},dt={key:1},pt={key:0,class:"note",style:{color:"#b91c1c","margin-top":"0.25rem"}},vt={key:1,class:"note",style:{color:"#064e3b","margin-top":"0.25rem"}},mt={key:3,class:"line discount"},ft={key:4,class:"line discount"},yt={key:5,class:"line discount"},gt={key:6,class:"line"},ht={style:{display:"flex",gap:"0.5rem","align-items":"center"}},bt={class:"line total"},_t={class:"order-actions"},wt={class:"input"},Pt={class:"readonly-field","aria-live":"polite"},At={class:"input"},Nt={class:"readonly-field","aria-live":"polite"},Ct={class:"input"},kt={class:"readonly-field","aria-live":"polite"},xt={key:1,class:"login-row"},Dt=["disabled"],St={class:"note","aria-live":"polite"},Mt={__name:"[id]",setup(p){const c=Ce(),w=ke(),d=Ee(),n=xe(),a=qe(),P=ze(),y=De(),g=N(!1),U=N(!1),k=c.params.id;Se(async()=>{if(k)try{await d.getTemplateById(k)}catch{}if(typeof n.init=="function")try{await n.init()}catch{}try{await B()}catch{}});function ne(){U.value=!1,g.value=!0}function oe(){U.value=!0,g.value=!0}function le(e){g.value=!1}const b=N(null);function ie(e){e&&(typeof e=="string"?b.value={fqdn:e,price:0,price_currency:"RUB",available:!0}:typeof e=="object"&&(b.value={fqdn:e.fqdn,price:e.price??0,price_currency:e.price_currency??e.priceCurrency??"RUB",available:e.available}))}function ue(){b.value=null}const W=l(()=>{var e;return Number(((e=b.value)==null?void 0:e.price)||0)}),x=l(()=>d.current||{id:null,title:"",price:0,image:"",description:"",pages:[],preview:"",discount_percent:0,discount_amount:0}),G=l(()=>Number(x.value.price||0)),u=N({extraPage:{enabled:!1,price:1e3,count:0},customization:{enabled:!1,pricePerHour:500,hours:0},priority:{enabled:!1,price:3e3},hosting:{enabled:!1,price:1e3}}),L=N({name:"",contact:""}),$=N(!1),S=N(!1),J=l(()=>(A.value||"").trim()),ce=l(()=>{const e=Number(u.value.extraPage.count||0),t=Number(u.value.extraPage.price||0);return u.value.extraPage.enabled&&e>0?e*t:0}),de=l(()=>{const e=Number(u.value.customization.hours||0),t=Number(u.value.customization.pricePerHour||0);return u.value.customization.enabled&&e>0?e*t:0}),pe=l(()=>u.value.priority.enabled?Number(u.value.priority.price||0):0),ve=l(()=>u.value.hosting.enabled?Number(u.value.hosting.price||0):0),h=l(()=>[G.value,ce.value,de.value,pe.value,ve.value,W.value].reduce((t,r)=>t+Number(r||0),0)),q=l(()=>{const e=Number(x.value.discount_amount||0),t=Number(x.value.discount_percent||0);return e>0?Math.min(e,h.value):t>0?Math.min(Math.round(h.value*t/100),h.value):0}),me=l(()=>{const e=Number(x.value.discount_amount||0),t=Number(x.value.discount_percent||0);return e>0?`${v(e)}`:t>0?`${t}%`:""}),R=l(()=>!!a.preview),Q=l(()=>{var e;return Number(((e=a.preview)==null?void 0:e.discount)||0)});l(()=>{var e;return Number(((e=a.preview)==null?void 0:e.finalAmount)??h.value)});const F=l(()=>{var e;return((e=a.preview)==null?void 0:e.code)||A.value}),T=l(()=>!!a.lastApplied),j=l(()=>{var e;return Number(((e=a.lastApplied)==null?void 0:e.discount)||0)}),I=l(()=>{var e;return((e=a.lastApplied)==null?void 0:e.code)||""}),fe=l(()=>{const e=Number(j.value||0),t=Number(Q.value||0);return T.value?Math.min(e,h.value):R.value?Math.min(t,h.value):0}),X=l(()=>{const e=Number(q.value||0),t=fe.value||0;return Math.min(e+t,h.value)}),E=l(()=>{const e=h.value-X.value;return e>0?Math.round(e):0});function v(e){try{const t=Number(e||0);return new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",maximumFractionDigits:0}).format(Math.round(t))}catch{return`${e} ₽`}}const A=N(""),_=N(null);K(A,()=>{_.value=null}),K(h,()=>{_.value=null});async function B(){const e=["clearPreview","clear","resetPreview","reset","clearApplied","clearAll"];for(const t of e)if(typeof a[t]=="function")try{await a[t]();return}catch{}try{"preview"in a&&(a.preview=null),"lastApplied"in a&&(a.lastApplied=null)}catch{}}function Y(){const e=n.user||{};return e.uid||e.id||e.userId||null}function V(e){if(!e)return"Ошибка при проверке промокода";const t=String(e);return/http\s*400|400/i.test(t)?"Промокод не применён — проверьте код и попробуйте снова.":/code\s+and\s+orderAmount|code и orderAmount|orderamount/i.test(t)?"Невозможно проверить промокод: сумма заказа не указана. Пожалуйста, выберите домен/товары.":t.length<140?t:"Невозможно проверить промокод"}async function Z(e){_.value=null;const t=J.value;if(!t){_.value="Введите код промокода";return}const r=Math.round(Number(h.value||0));if(r<=0){_.value="Выберите домен или добавьте опции, чтобы проверить промокод.";return}S.value=!0;try{typeof a.clearError=="function"&&a.clearError(),typeof a.clearPreview=="function"?a.clearPreview():a.preview=null;const o=await a.previewPromocode(t,r,"RUB");if(!o||o.success===!1){_.value=V(o==null?void 0:o.message);return}_.value=null}catch(o){console.error("onApplyPromo error",o),_.value=V((o==null?void 0:o.message)||o)}finally{S.value=!1}}async function ye(){if(!R.value||T.value)return{success:!0};const e=(F.value||A.value||"").trim();if(!e){try{await B()}catch{}return{success:!0}}const t=Y();if(!t){try{await B()}catch{}return{success:!0}}S.value=!0;try{typeof a.clearError=="function"&&a.clearError();const r=Math.round(Number(h.value||0)),o=await a.applyPromocode({code:e,uid:t,orderAmount:r,currency:"RUB"});if(o&&(o.success===!0||o.data))return{success:!0};const M=(o==null?void 0:o.message)||o&&o.data&&(o.data.message||o.data.error)||null,we=V(M);try{await B()}catch{}return{success:!0,message:we}}catch(r){console.error("_ensurePromoAppliedBeforeOrder error",r);try{await B()}catch{}return{success:!0,message:"Ошибка при применении промокода"}}finally{S.value=!1}}async function ge(){const e=["consumeApplied","consumePromocode","clearApplied","resetApplied","clearPreview","reset","clear","finalizePromo"];for(const t of e)if(typeof a[t]=="function")try{await a[t]();return}catch{}}const z=l(()=>!!n.isAuthenticated),ee=l(()=>{const e=n.user||{};if(e.name)return e.name;const t=e.firstName||e.first_name||"",r=e.lastName||e.last_name||"";return`${t} ${r}`.trim()||""}),te=l(()=>{const e=n.user||{};return e.email||e.email_address||e.phone||""}),H=l(()=>n.user||{}),he=l(()=>z.value&&!!b.value&&!!b.value.fqdn);K(z,e=>{e&&(ee.value&&(L.value.name=ee.value),te.value&&(L.value.contact=te.value))});async function be(){if(!z.value){w.push({path:"/login"});return}if(!b.value){y.showAlert({title:"Выберите домен",message:"Пожалуйста, выберите домен перед оформлением заказа.",type:"warning",typeClass:"alert-warning",background:"#fff3cd",color:"#856404",autoClose:{enabled:!0,delay:4e3}});return}$.value=!0;try{const e=await ye();e&&e.message&&y.showAlert({title:"Промокод",message:e.message,type:"warning",typeClass:"alert-warning",background:"#fff3cd",color:"#856404",autoClose:{enabled:!0,delay:5e3}});const t={templateId:x.value.id,price:E.value,paymentMethod:"balance",status:"pending_payment"};if(T.value||R.value){const M=I.value||F.value||A.value.trim();t.external={promocode:M||null,total_price:h.value,price:E.value,discount:X.value,user_uid:Y()},a.lastApplied&&a.lastApplied.redemptionId&&(t.external.uid=a.lastApplied.redemptionId)}const r=await P.createOrder(t);if(!r||r.success===!1){const M=r&&r.message?r.message:"Не удалось создать заказ";y.showAlert({title:"Ошибка",message:M,type:"error",typeClass:"alert-error",background:"#f8d7da",color:"#721c24",autoClose:{enabled:!0,delay:6e3}});return}const o=r.data;y.showAlert({title:"Заявка отправлена",message:`Итог: ${v(E.value)}`,type:"success",typeClass:"alert-success",background:"#d4edda",color:"#155724",autoClose:{enabled:!0,delay:4e3}});try{await P.fetchUserOrders({page:1,perPage:20})}catch(M){console.log(M,"error")}await ge(),await _e(),o&&o.id&&await Re({path:"/profile?tab=orders"})}catch(e){console.error(e),y.showAlert({title:"Ошибка",message:e&&e.message?e.message:"Ошибка при оформлении заказа",type:"error",typeClass:"alert-error",background:"#f8d7da",color:"#721c24",autoClose:{enabled:!0,delay:5e3}})}finally{$.value=!1}}async function _e(){u.value.extraPage.enabled=!1,u.value.extraPage.count=0,u.value.customization.enabled=!1,u.value.customization.hours=0,u.value.priority.enabled=!1,u.value.hosting.enabled=!1,L.value={name:"",contact:""},b.value=null;const e=["clearPreview","clearApplied","resetApplied","reset","clear"];for(const t of e)if(typeof a[t]=="function")try{await a[t]();break}catch{}A.value="",_.value=null}return(e,t)=>(f(),m("div",Fe,[s("div",je,[s("section",Ie,[s("div",Ve,[s("h1",He,'Сайт "'+i(x.value.title)+'"',1),t[6]||(t[6]=s("h3",{class:"card__h3"},"Дополнительные опции",-1)),s("div",Ke,[s("label",Oe,[ae(s("input",{type:"checkbox","onUpdate:modelValue":t[0]||(t[0]=r=>u.value.priority.enabled=r)},null,512),[[Me,u.value.priority.enabled]]),t[5]||(t[5]=s("span",{class:"switch-track","aria-hidden":""},[s("span",{class:"switch-thumb"})],-1)),s("span",We,"Приоритетная доработка — "+i(v(u.value.priority.price)),1)])]),t[7]||(t[7]=s("h3",{class:"card__h3 domain__h3"},"Выберите домен",-1)),s("div",Ge,[s("div",Je,[se(Le,{onSelectDomain:ie})])])]),s("div",Qe,[s("div",Xe,[s("span",Ye,i(v(x.value.price)),1)])])]),s("aside",Ze,[t[23]||(t[23]=s("h2",null,"Ваш заказ",-1)),s("div",et,[s("div",tt,[t[8]||(t[8]=s("span",null,"Базовая цена",-1)),s("span",null,i(v(G.value)),1)]),u.value.priority.enabled?(f(),m("div",st,[t[9]||(t[9]=s("span",null,"Приоритет",-1)),s("span",null,i(v(u.value.priority.price)),1)])):C("",!0),u.value.hosting.enabled?(f(),m("div",at,[t[10]||(t[10]=s("span",null,"Подключение / хостинг",-1)),s("span",null,i(v(u.value.hosting.price)),1)])):C("",!0),b.value?(f(),m("div",rt,[s("span",null,"Домен ("+i(b.value.fqdn)+")",1),s("span",null,i(v(W.value)),1)])):C("",!0),t[14]||(t[14]=s("hr",null,null,-1)),s("div",nt,[t[11]||(t[11]=s("strong",null,"Промежуточная сумма",-1)),s("strong",null,i(v(h.value)),1)]),s("div",ot,[s("div",lt,[ae(s("input",{"onUpdate:modelValue":t[1]||(t[1]=r=>A.value=r),onKeyup:Te(Z,["enter"]),disabled:O(a).loading||S.value,placeholder:"Введите промокод",class:"promocode__input",style:{flex:"1"},"aria-label":"Промокод"},null,40,it),[[Ue,A.value]]),s("button",{class:"btn primary",onClick:Z,disabled:O(a).loading||S.value||!J.value,title:"Нажмите, чтобы проверить и применить промокод"},[S.value?(f(),m("span",dt,"Применяется…")):(f(),m("span",ct,i(O(a).loading?"Обработка…":"Применить"),1))],8,ut)]),_.value?(f(),m("div",pt,i(_.value),1)):C("",!0),T.value?(f(),m("div",vt," Промокод «"+i(I.value)+"» успешно применён — скидка "+i(v(j.value))+". ",1)):C("",!0)]),R.value&&!T.value?(f(),m("div",mt,[s("span",null,"Промокод: "+i(F.value||A.value),1),s("span",null,"-"+i(v(Q.value)),1)])):C("",!0),T.value?(f(),m("div",ft,[s("span",null,"Промокод: "+i(I.value),1),s("span",null,"-"+i(v(j.value)),1)])):C("",!0),q.value>0?(f(),m("div",yt,[s("span",null,"Скидка шаблона "+i(me.value),1),s("span",null,"-"+i(v(q.value)),1)])):C("",!0),b.value?(f(),m("div",gt,[t[12]||(t[12]=s("span",null,"Выбран домен",-1)),s("span",ht,[s("strong",null,i(b.value.fqdn),1),s("button",{class:"btn ghost",onClick:ue,title:"Сбросить выбор домена"},"Сбросить")])])):C("",!0),s("div",bt,[t[13]||(t[13]=s("strong",null,"Итого",-1)),s("strong",null,i(v(E.value)),1)])]),s("div",_t,[z.value?(f(),m(Be,{key:0},[s("label",wt,[t[15]||(t[15]=D(" ФИО: ")),s("div",Pt,i(H.value.fullname||"—"),1)]),s("label",At,[t[16]||(t[16]=D(" Телефон: ")),s("div",Nt,i(H.value.phone||"—"),1)]),s("label",Ct,[t[17]||(t[17]=D(" Почта: ")),s("div",kt,i(H.value.email||"—"),1)])],64)):(f(),m("div",xt,[t[18]||(t[18]=D(" Необходимо ")),s("button",{class:"btn-link",onClick:ne},"Войти"),t[19]||(t[19]=D(" или ")),s("button",{class:"btn-link",onClick:oe},"Зарегистрироваться")])),s("button",{class:"btn primary",disabled:$.value||!he.value,onClick:be},i($.value?"Оформление…":"Оформить заказ"),9,Dt),s("div",St,[s("small",null,[t[20]||(t[20]=D(" Нажимая «Оформить заказ», вы соглашаетесь с ")),s("a",{onClick:t[2]||(t[2]=r=>e.openInNewTab("/terms"))},"условиями оферты"),t[21]||(t[21]=D(" и ")),s("a",{onClick:t[3]||(t[3]=r=>e.openInNewTab("/privacy"))},"политикой конфиденциальности"),t[22]||(t[22]=D(". "))])])])])]),se($e,{visible:g.value,"onUpdate:visible":t[4]||(t[4]=r=>g.value=r),onLogin:le,startWithRegister:U.value},null,8,["visible","startWithRegister"])]))}},Et=Ne(Mt,[["__scopeId","data-v-93c0247f"]]);export{Et as default};
