import{_ as V,c as m,o as _,x as fe,p as E,i as b,y as D,z as B,j as Q,a as e,t as k,g as q,B as de,h as U,v as T,n as Y,k as _e,d as G,b as ee,C as R,D as pe,F as te,r as se,E as le,G as Z,H as L,s as ve,q as me,w as ge,I as J}from"./xo8e5jVH.js";import ye from"./CRKbhWNU.js";import{u as he}from"./DZg870Wl.js";const be={},we={class:"block-header__container"};function $e(N,a){return _(),m("div",we,[fe(N.$slots,"default",{},void 0,!0)])}const ke=V(be,[["render",$e],["__scopeId","data-v-dcdaca36"]]),xe={class:"profile-info"},Ce={class:"profile-info__header"},Pe={key:1,class:"profile-info__actions"},Se=["disabled"],Ue={key:0,class:"profile-info__content"},Ne={class:"profile-info__item"},Ie={class:"profile-info__value"},Fe={class:"profile-info__item"},Oe={class:"profile-info__value"},Ve={class:"profile-info__item"},Ae={class:"profile-info__value"},Te={key:0,class:"profile-info__item"},De={class:"profile-info__value"},Re={class:"profile-info__form-group"},Be={class:"profile-info__form-group"},qe={class:"profile-info__form-group"},Ee={class:"profile-info__form-group"},Me={__name:"ProfileInfo",setup(N){const a=E(),f=b(!1),v=b(!1);function p(l={}){var y,h,w,C;const s=(l.phone||"").replace(/\D/g,""),o=s.length===11&&s.startsWith("7")?`+7 (${s.slice(1,4)}) ${s.slice(4,7)}-${s.slice(7,9)}-${s.slice(9,11)}`:l.phone||"";return{uid:l.uid||l.id||null,username:l.username||"",name:l.fullname||l.username||"",email:l.email||"",phone:o,telegram:l.tg||l.telegram||"",city:l.city||"",avatar:l.avatar||null,notifications:{email:((y=l.notifications)==null?void 0:y.email)??!0,telegram:((h=l.notifications)==null?void 0:h.telegram)??!0,sms:((w=l.notifications)==null?void 0:w.sms)??!1},security:{twoFactor:((C=l.security)==null?void 0:C.twoFactor)??!1},raw:l}}const d=D(()=>a.user?p(a.user):null),r=b({uid:null,name:"",username:"",email:"",phone:"",telegram:"",city:"",avatar:null,notifications:{email:!0,telegram:!0,sms:!1},security:{twoFactor:!1},raw:null});B(d,l=>{l?f.value||(r.value={...l,notifications:{...l.notifications},security:{...l.security}}):r.value={uid:null,name:"",username:"",email:"",phone:"",telegram:"",city:"",avatar:null,notifications:{email:!0,telegram:!0,sms:!1},security:{twoFactor:!1},raw:null}},{immediate:!0});function n(){d.value&&(r.value={...d.value,notifications:{...d.value.notifications},security:{...d.value.security}}),f.value=!1}Q(async()=>{});async function u(){try{v.value=!0;const l={fullname:r.value.name,email:r.value.email,phone:(r.value.phone||"").replace(/\D/g,""),tg:r.value.telegram,city:r.value.city,notifications:{email:!!r.value.notifications.email,telegram:!!r.value.notifications.telegram,sms:!!r.value.notifications.sms},security:{twoFactor:!!r.value.security.twoFactor}},o=await a.updateProfile(l)||a.user;o&&(a.user=o,r.value={...p(o)},f.value=!1)}catch(l){console.error("Ошибка сохранения профиля:",l)}finally{v.value=!1}}return(l,s)=>{var o,y,h,w,C;return _(),m("div",xe,[e("div",Ce,[s[5]||(s[5]=e("h2",{class:"profile-info__title"},"Личные данные",-1)),f.value?(_(),m("div",Pe,[e("button",{class:"button button--outline",onClick:n}," Отмена "),e("button",{class:"button button--primary",disabled:v.value,onClick:u},k(v.value?"Сохранение...":"Сохранить"),9,Se)])):(_(),m("button",{key:0,class:"button button--outline",onClick:s[0]||(s[0]=x=>f.value=!0)}," Редактировать "))]),f.value?(_(),m("form",{key:1,class:"profile-info__form",onSubmit:de(u,["prevent"])},[e("div",Re,[s[10]||(s[10]=e("label",{class:"profile-info__form-label"},"Имя",-1)),U(e("input",{"onUpdate:modelValue":s[1]||(s[1]=x=>r.value.name=x),type:"text",class:"profile-info__form-input"},null,512),[[T,r.value.name]])]),e("div",Be,[s[11]||(s[11]=e("label",{class:"profile-info__form-label"},"Email",-1)),U(e("input",{"onUpdate:modelValue":s[2]||(s[2]=x=>r.value.email=x),type:"email",class:"profile-info__form-input"},null,512),[[T,r.value.email]])]),e("div",qe,[s[12]||(s[12]=e("label",{class:"profile-info__form-label"},"Телефон",-1)),U(e("input",{"onUpdate:modelValue":s[3]||(s[3]=x=>r.value.phone=x),type:"tel",class:"profile-info__form-input"},null,512),[[T,r.value.phone]])]),e("div",Ee,[s[13]||(s[13]=e("label",{class:"profile-info__form-label"},"Город",-1)),U(e("input",{"onUpdate:modelValue":s[4]||(s[4]=x=>r.value.city=x),type:"text",class:"profile-info__form-input"},null,512),[[T,r.value.city]])])],32)):(_(),m("div",Ue,[e("div",Ne,[s[6]||(s[6]=e("span",{class:"profile-info__label"},"Имя:",-1)),e("span",Ie,k((o=d.value)==null?void 0:o.name),1)]),e("div",Fe,[s[7]||(s[7]=e("span",{class:"profile-info__label"},"Email:",-1)),e("span",Oe,k((y=d.value)==null?void 0:y.email),1)]),e("div",Ve,[s[8]||(s[8]=e("span",{class:"profile-info__label"},"Телефон:",-1)),e("span",Ae,k((h=d.value)==null?void 0:h.phone),1)]),(w=d.value)!=null&&w.city?(_(),m("div",Te,[s[9]||(s[9]=e("span",{class:"profile-info__label"},"Город:",-1)),e("span",De,k((C=d.value)==null?void 0:C.city),1)])):q("",!0)]))])}}},je=V(Me,[["__scopeId","data-v-867202f1"]]),ze={class:"profile-orders"},He={key:0,class:"profile-orders__loading"},Ge={key:1,class:"profile-orders__loading"},Je={key:2,class:"profile-orders__empty"},Qe={key:3,class:"profile-orders__table"},We={class:"profile-orders__cell profile-orders__cell--date"},Ke={class:"profile-orders__cell profile-orders__cell--template"},Xe={class:"profile-orders__template"},Ye=["src"],Ze={key:1,class:"profile-orders__thumb profile-orders__thumb--placeholder"},Le={class:"profile-orders__template-info"},et={class:"profile-orders__template-title"},tt={class:"profile-orders__cell profile-orders__cell--status"},st={class:"profile-orders__cell profile-orders__cell--price"},lt={class:"profile-orders__cell profile-orders__cell--actions"},it=["onClick"],at={class:"profile-orders__row",style:{"border-top":"none"}},ot={class:"profile-orders__cell",style:{"grid-column":"1 / -1",display:"flex","justify-content":"center",padding:"20px"}},rt={key:0,class:"profile-orders__loading"},nt={key:1,class:"profile-orders__loading"},ut={__name:"ProfileOrders",setup(N){E();const a=he(),f=b([]),v=b(!1),p=b(!1),d=b(null),r=b(1),n=b(20),u=b(null),l=b(!1),s=b(null);let o=null;function y(t){return Z({path:t})}function h(t){if(t)return Z({path:`/profile/orders/${t}`})}function w(t){if(!t)return"";const i=t.created_at??t.createdAt??t.date??t.order_date??t.created??t;let c;if(i instanceof Date)c=i;else if(typeof i=="number"){const $=i<1e12&&i<1e10?i*1e3:i;c=new Date($)}else c=new Date(String(i));return Number.isNaN(c.getTime())?String(i??""):c.toLocaleString("ru-RU",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"})}function C(t){var i,c;return((i=t.template)==null?void 0:i.title)??((c=t.template)==null?void 0:c.name)??t.template_title??t.templateName??(typeof t.template=="string"?t.template:null)??"—"}function x(t){return t.status??t.state??"—"}function ie(t){const i=t.status??t.state??"";return String(i).toLowerCase().replace(/\s+/g,"_")||"unknown"}function ae(t){const i=t.price??t.amount??t.total,c=t.currency??t.currency_code??"RUB";if(typeof i=="number"&&!Number.isNaN(i))try{return new Intl.NumberFormat("ru-RU",{style:"currency",currency:c}).format(i)}catch{return`${i}`}return i??"—"}function oe(t){var c,$,I,F,O,g,P,A;const i=[t.preview,(c=t.template)==null?void 0:c.image,($=t.template)==null?void 0:$.preview,t.template_image,t.template_preview,t.image,(F=(I=t.raw)==null?void 0:I.template)==null?void 0:F.image,(g=(O=t.raw)==null?void 0:O.template)==null?void 0:g.preview,(P=t.raw)==null?void 0:P.template_image,(A=t.raw)==null?void 0:A.preview];for(const S of i)if(S&&typeof S=="string"&&S.trim()!=="")return S;return null}async function M(t=1,i=!1){var c,$,I,F,O;if(!(t===1&&v.value)&&!(t>1&&(p.value||v.value))&&!(l.value&&t>1)){t===1?(v.value=!0,d.value=null):p.value=!0;try{const g=await a.fetchUserOrders({page:t,perPage:n.value});if(!g.success){d.value=g.message||"Ошибка получения заказов",a.orders&&a.orders.length>0&&!i&&(f.value=a.orders.map(W));return}const P=((c=g.data)==null?void 0:c.rows)??(g.data??[]).rows??a.orders??[],A=(($=g.data)==null?void 0:$.page)??t,S=((I=g.data)==null?void 0:I.perPage)??n.value,K=((F=g.data)==null?void 0:F.totalCount)??((O=g.data)==null?void 0:O.total)??a.totalCount??null;u.value=K!==void 0?Number(K):null,r.value=A,n.value=S;const X=(P||[]).map(W);if(i){const ue=new Set(f.value.map(H=>H.id)),ce=X.filter(H=>!ue.has(H.id));f.value=f.value.concat(ce)}else f.value=X;!P||P.length===0||P.length<n.value||u.value!==null&&f.value.length>=u.value?(l.value=!0,z()):l.value=!1}catch(g){console.error("loadOrdersPage error",g),d.value=(g==null?void 0:g.message)??"Сетевая ошибка"}finally{v.value=!1,p.value=!1}}}function W(t){return{id:t.id,date:w(t),template:C(t),status:x(t),statusCode:ie(t),price:ae(t),preview:oe(t),raw:t}}async function re(){if(l.value||p.value||v.value)return;const t=(r.value||1)+1;await M(t,!0)}function j(){typeof window>"u"||!("IntersectionObserver"in window)||(o&&o.disconnect(),o=new IntersectionObserver(async t=>{for(const i of t)i.isIntersecting&&!v.value&&!p.value&&!l.value&&await re()},{root:null,rootMargin:"200px",threshold:.1}),s.value&&o.observe(s.value))}function z(){o&&(o.disconnect(),o=null)}Q(async()=>{await M(1,!1),await Y(),j()}),B(s,t=>{t?j():z()}),_e(()=>{z()});async function ne(){l.value=!1,r.value=1,u.value=null,await M(1,!1),await Y(),j()}return(t,i)=>(_(),m("div",ze,[i[5]||(i[5]=e("h2",{class:"profile-orders__title"},"Мои заказы",-1)),v.value?(_(),m("div",He," Загрузка заказов... ")):d.value?(_(),m("div",Ge,[G(" Ошибка: "+k(d.value)+" ",1),e("div",{style:{"margin-top":"12px"}},[e("button",{class:"primary__button",onClick:ne},"Повторить")])])):f.value.length===0?(_(),m("div",Je,[i[3]||(i[3]=G(" У вас пока нет заказов ")),e("button",{class:"primary__button",onClick:i[0]||(i[0]=c=>y("/templates"))},[i[2]||(i[2]=G(" Купить сайт ")),ee(R(ye),{class:"next-cirlce__svg"})])])):(_(),m("div",Qe,[i[4]||(i[4]=pe('<div class="profile-orders__row profile-orders__row--header" data-v-8a5f5392><div class="profile-orders__cell" data-v-8a5f5392>Дата</div><div class="profile-orders__cell" data-v-8a5f5392>Шаблон</div><div class="profile-orders__cell" data-v-8a5f5392>Статус</div><div class="profile-orders__cell" data-v-8a5f5392>Сумма</div><div class="profile-orders__cell" data-v-8a5f5392>Действия</div></div>',1)),(_(!0),m(te,null,se(f.value,c=>(_(),m("div",{key:c.id,class:"profile-orders__row"},[e("div",We,k(c.date),1),e("div",Ke,[e("div",Xe,[c.raw.template.preview?(_(),m("img",{key:0,src:c.raw.template.preview,class:"profile-orders__thumb",onError:i[1]||(i[1]=$=>{$.target.style.display="none"})},null,40,Ye)):(_(),m("div",Ze)),e("div",Le,[e("div",et,k(c.template),1)])])]),e("div",tt,[e("span",{class:le(["profile-orders__status",`profile-orders__status--${c.statusCode}`])},k(c.status),3)]),e("div",st,k(c.price),1),e("div",lt,[e("button",{class:"profile-orders__action",onClick:$=>h(c.id)}," Подробнее ",8,it)])]))),128)),e("div",at,[e("div",ot,[p.value?(_(),m("div",rt,"Загрузка...")):l.value?(_(),m("div",nt,"Больше заказов нет")):q("",!0)])]),e("div",{ref_key:"sentinel",ref:s,style:{height:"1px",width:"100%"}},null,512)]))]))}},ct=V(ut,[["__scopeId","data-v-8a5f5392"]]),ft={class:"profile-settings"},dt={class:"profile-settings__section"},_t={class:"profile-settings__option"},pt=["title"],vt=["disabled"],mt={class:"profile-settings__option"},gt={style:{display:"flex","align-items":"center",gap:"12px"}},yt=["disabled"],ht=["title"],bt=["disabled"],wt={__name:"ProfileSettings",setup(N){const a=E(),f=D(()=>!!a.user),v=D({get(){return a.user?Number(a.user.email_access)===1:!1},set(r){if(!a.user)return;const n=r?1:0;a.user.email_access=n,a.isAuthenticated&&a.updateProfile({email_access:n}).catch(async()=>{try{await a.fetchCurrentUser()}catch{}})}}),p=D({get(){return a.user?Number(a.user.tg_access)===1:!1},set(r){if(!a.user)return;const n=r?1:0;a.user.tg_access=n,a.isAuthenticated&&a.updateProfile({tg_access:n}).catch(async()=>{try{await a.fetchCurrentUser()}catch{}})}});function d(){if(!a.user||!a.user.uid)return;const r={uid:a.user.uid},u=`https://t.me/sitebypro_official_bot?start=${btoa(JSON.stringify(r))}`;window.open(u,"_blank")}return(r,n)=>(_(),m("div",ft,[n[7]||(n[7]=e("h2",{class:"profile-settings__title"},"Настройки",-1)),e("div",dt,[n[6]||(n[6]=e("h3",{class:"profile-settings__subtitle"},"Уведомления",-1)),e("div",_t,[n[3]||(n[3]=e("div",{class:"profile-settings__option-info"},[e("div",{class:"profile-settings__option-title"},"Email уведомления"),e("div",{class:"profile-settings__option-desc"}," Получать новости и обновления на почту с ваших сайтов ")],-1)),e("label",{class:"profile-settings__switch",title:f.value?"":"Профиль не загружен"},[U(e("input",{type:"checkbox","onUpdate:modelValue":n[0]||(n[0]=u=>v.value=u),class:"profile-settings__switch-input",disabled:!f.value||R(a).loading},null,8,vt),[[L,v.value]]),n[2]||(n[2]=e("span",{class:"profile-settings__switch-slider"},null,-1))],8,pt)]),e("div",mt,[n[5]||(n[5]=e("div",{class:"profile-settings__option-info"},[e("div",{class:"profile-settings__option-title"},"Telegram уведомления"),e("div",{class:"profile-settings__option-desc"}," Получать важные уведомления в Telegram с ваших сайтов ")],-1)),e("div",gt,[e("button",{class:"profile-settings__connect-btn",onClick:d,disabled:!f.value||R(a).loading,type:"button"}," Привязать Telegram ",8,yt),e("label",{class:"profile-settings__switch",title:f.value?"":"Профиль не загружен"},[U(e("input",{type:"checkbox","onUpdate:modelValue":n[1]||(n[1]=u=>p.value=u),class:"profile-settings__switch-input",disabled:!f.value||R(a).loading},null,8,bt),[[L,p.value]]),n[4]||(n[4]=e("span",{class:"profile-settings__switch-slider"},null,-1))],8,ht)])])])]))}},$t=V(wt,[["__scopeId","data-v-8ee05b4e"]]),kt={key:0,class:"profile"},xt={class:"profile__tabs"},Ct=["onClick","aria-pressed"],Pt={class:"profile__content"},St={__name:"profile",setup(N){const a=[{id:"orders",title:"Мои заказы"},{id:"info",title:"Профиль"},{id:"settings",title:"Настройки"}],f=a.map(o=>o.id),v=ve(),p=me(),d=E(),r=o=>{var w;const y=(w=o==null?void 0:o.query)==null?void 0:w.tab;return Array.isArray(y)?y[0]:y},n=r(v),u=b(f.includes(n)?n:"info"),l=b(!1);function s(o){f.includes(o)&&(u.value=o,p.replace({query:{...v.query,tab:o}}).catch(()=>{}))}return B(()=>v.fullPath,()=>{const o=r(v);o&&f.includes(o)&&o!==u.value?u.value=o:!o&&u.value!=="info"&&(u.value="info")}),B(()=>d.isAuthenticated,o=>{o||p.currentRoute.value.path!=="/"&&p.replace({path:"/"}).catch(()=>{})}),Q(()=>{const o=r(v);if((!o||!f.includes(o))&&p.replace({query:{...v.query,tab:u.value}}).catch(()=>{}),d.initFromStorage(),!d.isAuthenticated){l.value=!1,p.currentRoute.value.path!=="/"&&p.replace({path:"/"}).catch(()=>{});return}(async()=>{try{if(await d.fetchCurrentUser(),!d.isAuthenticated){p.currentRoute.value.path!=="/"&&p.replace({path:"/"}).catch(()=>{}),l.value=!1;return}l.value=!0}catch{p.currentRoute.value.path!=="/"&&p.replace({path:"/"}).catch(()=>{}),l.value=!1}})()}),(o,y)=>l.value?(_(),m("div",kt,[ee(ke,null,{default:ge(()=>y[0]||(y[0]=[e("h1",{class:"profile__title"},"Личный кабинет",-1),e("p",{class:"profile__subtitle"},"Управляйте своими заказами и настройками",-1)])),_:1,__:[0]}),e("div",xt,[(_(),m(te,null,se(a,h=>e("button",{key:h.id,class:le(["profile__tab",{"profile__tab--active":u.value===h.id}]),onClick:w=>s(h.id),"aria-pressed":u.value===h.id},k(h.title),11,Ct)),64))]),e("div",Pt,[u.value==="info"?(_(),J(je,{key:0})):u.value==="orders"?(_(),J(ct,{key:1})):u.value==="settings"?(_(),J($t,{key:2})):q("",!0)])])):q("",!0)}},Ft=V(St,[["__scopeId","data-v-16abeb9d"]]);export{Ft as default};
