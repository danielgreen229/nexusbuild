import{f as p,A as O,p as _}from"./xo8e5jVH.js";const o=`${O.fullUrl}/order`;function y(e,s=null){const t=Number(e);return Number.isInteger(t)?t:s}function x(e={}){const s={paymentMethod:"payment_method",payment_method:"payment_method",netlifyUrl:"netlify_url",netlify_url:"netlify_url",adminUrl:"admin_url",admin_url:"admin_url",completedAt:"completed_at",completed_at:"completed_at",price:"price",status:"status",orderExternalUid:"order_externals_uid",order_externals_uid:"order_externals_uid"},t={};return Object.keys(e).forEach(r=>{s[r]&&(t[s[r]]=e[r])}),t}const w=p("orders",{state:()=>({loading:!1,error:null,orders:[],page:1,perPage:20,totalCount:0,currentOrder:null,adminOrders:[],adminStats:null,lastCreated:null}),actions:{clearError(){this.error=null},reset(){this.loading=!1,this.error=null,this.orders=[],this.page=1,this.perPage=20,this.totalCount=0,this.currentOrder=null,this.adminOrders=[],this.adminStats=null,this.lastCreated=null},_extractData(e){return e?e.data??e:null},async _doFetch(e,s={}){this.loading=!0,this.error=null;try{const t=_(),r=t&&t.user?t.user:typeof window<"u"?JSON.parse(localStorage.getItem("user")||"null"):null,a=t&&t.token?t.token:typeof window<"u"?localStorage.getItem("token"):null,n=(s.method||"GET").toUpperCase(),d=Object.assign({},s.headers||{}),l=Object.assign({},s,{method:n,headers:d,credentials:"omit"});let c=e;if(n==="GET"&&r){const i=encodeURIComponent(JSON.stringify(r));c+=(c.includes("?")?"&":"?")+`user=${i}`}if(n!=="GET"){let i=l.body;if(i instanceof FormData)r&&i.append("user",JSON.stringify(r)),delete l.headers["Content-Type"],l.body=i;else{let h=null;if(typeof i=="string"&&i.length>0)try{h=JSON.parse(i)}catch{h=null}else typeof i=="object"&&i!==null?h=i:h={};r&&(h.user=r),l.headers["Content-Type"]=l.headers["Content-Type"]||"application/json",l.body=JSON.stringify(h)}}a&&!l.headers.Authorization&&(l.headers.Authorization=`Bearer ${a}`),l.headers.Accept||(l.headers.Accept="application/json");const u=await fetch(c,l),f=await u.text().catch(()=>null);let m=null;try{m=f?JSON.parse(f):null}catch{m=null}const g=this._extractData(m);if(!u.ok){const i=g&&(g.message||g.error)||`HTTP ${u.status}`;return this.error=i,{success:!1,status:u.status,data:null,message:i,raw:m??f}}return{success:!0,status:u.status,data:g,raw:m??f}}catch(t){return console.error("_doFetch error",t),this.error=t.message||"Network error",{success:!1,data:null,message:this.error}}finally{this.loading=!1}},async fetchUserOrders(e={}){this.loading=!0,this.error=null;try{const s=y(e.page,1)||1,t=y(e.perPage,20)||20,r=new URLSearchParams;r.set("page",String(s)),r.set("perPage",String(t)),e.status&&r.set("status",e.status),e.joinExternal&&r.set("joinExternal","1"),console.log(r,"paramsZXC");const a=await this._doFetch(`${o}?${r.toString()}`,{method:"GET"});if(!a.success)return{success:!1,message:a.data||"Ошибка получения заказов",data:null};const n=a.data??a.raw,d=n.rows??n.orders??[],l=n.page??s,c=n.perPage??t,u=n.totalCount??n.total??0;return this.orders=d,this.page=l,this.perPage=c,this.totalCount=u,{success:!0,data:{rows:d,page:l,perPage:c,totalCount:u}}}catch(s){return console.error("fetchUserOrders error",s),this.error=s.message||"Ошибка",{success:!1,message:this.error,data:null}}finally{this.loading=!1}},async fetchOrderById(e,s={}){if(!e)return{success:!1,message:"orderId required",data:null};this.loading=!0,this.error=null;try{const t=new URLSearchParams;s.joinExternal&&t.set("joinExternal","1");const r=t.toString()?`?${t.toString()}`:"",a=await this._doFetch(`${o}/${encodeURIComponent(e)}${r}`,{method:"GET"});return a.success?(this.currentOrder=a.data,{success:!0,data:a.data}):{success:!1,message:a.message||"Ошибка получения заказа",data:null}}catch(t){return console.error("fetchOrderById error",t),this.error=t.message||"Ошибка",{success:!1,message:this.error,data:null}}finally{this.loading=!1}},async createOrder(e={}){this.loading=!0,this.error=null;try{if(!e.templateId||isNaN(Number(e.templateId))){const a="templateId required";return this.error=a,{success:!1,message:a,data:null}}if(typeof e.price>"u"||isNaN(Number(e.price))){const a="price required";return this.error=a,{success:!1,message:a,data:null}}const s={templateId:Number(e.templateId),price:Number(e.price),payment_method:e.paymentMethod??e.payment_method??"balance",status:e.status??"pending_payment"};e.external&&typeof e.external=="object"?s.external=e.external:(e.order_externals_uid||e.orderExternalUid)&&(s.order_externals_uid=e.order_externals_uid??e.orderExternalUid);const t=await this._doFetch(o,{method:"POST",body:JSON.stringify(s)});if(!t.success)return{success:!1,message:t.message||"Ошибка создания",data:null};const r=t.data;return this.lastCreated=r,r&&(this.orders=[r,...this.orders]),{success:!0,data:r}}catch(s){return console.error("createOrder error",s),this.error=s.message||"Ошибка",{success:!1,message:this.error,data:null}}finally{this.loading=!1}},async updateOrder(e,s={}){if(!e)return{success:!1,message:"orderId required",data:null};const t=x(s);if(Object.keys(t).length===0)return{success:!1,message:"No fields to update",data:null};this.loading=!0,this.error=null;try{const r=await this._doFetch(`${o}/${encodeURIComponent(e)}`,{method:"PUT",body:JSON.stringify(t)});if(!r.success)return{success:!1,message:r.message||"Ошибка обновления",data:null};const a=r.data;return this.currentOrder&&this.currentOrder.id===a.id&&(this.currentOrder=a),this.orders=this.orders.map(n=>n.id===a.id?a:n),this.adminOrders=this.adminOrders.map(n=>n.id===a.id?a:n),{success:!0,data:a}}catch(r){return console.error("updateOrder error",r),this.error=r.message||"Ошибка",{success:!1,message:this.error,data:null}}finally{this.loading=!1}},async updateOrderStatus(e,{status:s,completedAt:t=null}={}){if(!e)return{success:!1,message:"orderId required",data:null};if(!s)return{success:!1,message:"status required",data:null};this.loading=!0,this.error=null;try{const r={status:s};t&&(r.completedAt=t);const a=await this._doFetch(`${o}/${encodeURIComponent(e)}/status`,{method:"PATCH",body:JSON.stringify(r)});if(!a.success)return{success:!1,message:a.message||"Ошибка обновления статуса",data:null};const n=a.data;return this.currentOrder&&this.currentOrder.id===n.id&&(this.currentOrder=n),this.orders=this.orders.map(d=>d.id===n.id?n:d),this.adminOrders=this.adminOrders.map(d=>d.id===n.id?n:d),{success:!0,data:n}}catch(r){return console.error("updateOrderStatus error",r),this.error=r.message||"Ошибка",{success:!1,message:this.error,data:null}}finally{this.loading=!1}},async deleteOrder(e){if(!e)return{success:!1,message:"orderId required",data:null};this.loading=!0,this.error=null;try{const s=await this._doFetch(`${o}/${encodeURIComponent(e)}`,{method:"DELETE"});return s.success?(this.orders=this.orders.filter(t=>t.id!==e),this.adminOrders=this.adminOrders.filter(t=>t.id!==e),this.currentOrder&&this.currentOrder.id===e&&(this.currentOrder=null),{success:!0,data:s.data??s.raw}):{success:!1,message:s.message||"Ошибка удаления",data:null}}catch(s){return console.error("deleteOrder error",s),this.error=s.message||"Ошибка",{success:!1,message:this.error,data:null}}finally{this.loading=!1}},async fetchAdminAll(e={}){this.loading=!0,this.error=null;try{const s=new URLSearchParams;e.status&&s.set("status",e.status),e.userId&&s.set("userId",e.userId),e.userUid&&s.set("userUid",e.userUid),e.templateId&&s.set("templateId",e.templateId),e.dateFrom&&s.set("dateFrom",e.dateFrom),e.dateTo&&s.set("dateTo",e.dateTo),typeof e.limit<"u"&&s.set("limit",String(e.limit)),e.joinExternal&&s.set("joinExternal","1");const t=`${o}/admin/all?${s.toString()}`,r=await this._doFetch(t,{method:"GET"});if(!r.success)return{success:!1,message:r.message||"Ошибка получения админ-списка",data:null};const a=r.data??r.raw;return this.adminOrders=a.orders??a.rows??[],this.totalCount=a.totalCount??this.totalCount,{success:!0,data:{orders:this.adminOrders,totalCount:this.totalCount}}}catch(s){return console.error("fetchAdminAll error",s),this.error=s.message||"Ошибка",{success:!1,message:this.error,data:null}}finally{this.loading=!1}},async fetchAdminStats(){this.loading=!0,this.error=null;try{const e=await this._doFetch(`${o}/admin/stats`,{method:"GET"});if(!e.success)return{success:!1,message:e.message||"Ошибка получения статистики",data:null};const s=e.data??e.raw;return this.adminStats=s.stats??s,this.totalCount=s.totalCount??this.totalCount,{success:!0,data:{totalCount:this.totalCount,stats:this.adminStats}}}catch(e){return console.error("fetchAdminStats error",e),this.error=e.message||"Ошибка",{success:!1,message:this.error,data:null}}finally{this.loading=!1}},async linkOrderToExternal(e,s){if(!e)return{success:!1,message:"orderId required",data:null};if(!s)return{success:!1,message:"externalUid required",data:null};this.loading=!0,this.error=null;try{const t=await this._doFetch(`${o}/${encodeURIComponent(e)}/link-external`,{method:"POST",body:JSON.stringify({externalUid:s})});if(!t.success)return{success:!1,message:t.message||"Ошибка привязки",data:null};const r=t.data;return this.currentOrder&&this.currentOrder.id===r.id&&(this.currentOrder=r),this.orders=this.orders.map(a=>a.id===r.id?r:a),this.adminOrders=this.adminOrders.map(a=>a.id===r.id?r:a),{success:!0,data:r}}catch(t){return console.error("linkOrderToExternal error",t),this.error=t.message||"Ошибка",{success:!1,message:this.error,data:null}}finally{this.loading=!1}},async fetchAdminExternal(e){if(!e)return{success:!1,message:"uid required",data:null};this.loading=!0,this.error=null;try{const s=await this._doFetch(`${o}/admin/external/${encodeURIComponent(e)}`,{method:"GET"});return s.success?{success:!0,data:s.data}:{success:!1,message:s.message||"Ошибка получения external",data:null}}catch(s){return console.error("fetchAdminExternal error",s),this.error=s.message||"Ошибка",{success:!1,message:this.error,data:null}}finally{this.loading=!1}},async createAdminExternal(e={}){this.loading=!0,this.error=null;try{const s={...e},t=await this._doFetch(`${o}/admin/external`,{method:"POST",body:JSON.stringify(s)});return t.success?{success:!0,data:t.data}:{success:!1,message:t.message||"Ошибка создания external",data:null}}catch(s){return console.error("createAdminExternal error",s),this.error=s.message||"Ошибка",{success:!1,message:this.error,data:null}}finally{this.loading=!1}},async updateAdminExternal(e,s={}){if(!e)return{success:!1,message:"uid required",data:null};this.loading=!0,this.error=null;try{const t={...s},r=await this._doFetch(`${o}/admin/external/${encodeURIComponent(e)}`,{method:"PUT",body:JSON.stringify(t)});return r.success?{success:!0,data:r.data}:{success:!1,message:r.message||"Ошибка обновления external",data:null}}catch(t){return console.error("updateAdminExternal error",t),this.error=t.message||"Ошибка",{success:!1,message:this.error,data:null}}finally{this.loading=!1}},async deleteAdminExternal(e){if(!e)return{success:!1,message:"uid required",data:null};this.loading=!0,this.error=null;try{const s=await this._doFetch(`${o}/admin/external/${encodeURIComponent(e)}`,{method:"DELETE"});return s.success?{success:!0,data:s.data??s.raw}:{success:!1,message:s.message||"Ошибка удаления external",data:null}}catch(s){return console.error("deleteAdminExternal error",s),this.error=s.message||"Ошибка",{success:!1,message:this.error,data:null}}finally{this.loading=!1}}}});export{w as u};
