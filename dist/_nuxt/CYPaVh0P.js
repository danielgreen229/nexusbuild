import{h as Ae,A as Ce,_ as ke,L as Me,K as Te,J as xe,D as Be,C as Re,k as M,l as Ue,E as l,M as I,p as De,c as w,o as P,a as r,b as le,t as u,i as ne,X as Ee,f as S,v as Se,y as Z,P as $e,d as T,F as Le,Z as qe,m as ze}from"./D_JQTfwH.js";import{u as Fe}from"./BSKtGGBX.js";import{D as Ie}from"./DsupwO5L.js";const ie=`${Ce.fullUrl}/promocode`,Ve=Ae("promocodes",{state:()=>({loading:!1,error:null,lastApplied:null,preview:null}),actions:{clearError(){this.error=null},reset(){this.loading=!1,this.error=null,this.lastApplied=null,this.preview=null},_extractData(v){return v?v.data??v:null},async getPromoByCode(v){this.loading=!0,this.error=null;try{if(!v)return{success:!1,message:"code is required",data:null};const c=await fetch(`${ie}/by-code/${encodeURIComponent(v)}`,{method:"GET",headers:{Accept:"application/json"}}),A=await c.json().catch(()=>null),d=this._extractData(A);if(!c.ok){const o=d&&(d.message||d.error)||`HTTP ${c.status}`;return this.error=o,{success:!1,message:d.data,data:null}}return{success:!0,data:d}}catch(c){return console.error("getPromoByCode error",c),this.error=c.message||"Network error",{success:!1,message:this.error,data:null}}finally{this.loading=!1}},calculateDiscountLocal(v,c){if(!v)return{discount:0,finalAmount:Number(c)};const A=(v.discount_type||"").toLowerCase(),d=Number(v.discount_value||0);let o=0;A==="percent"?o=Number(c)*d/100:o=d,o>Number(c)&&(o=Number(c)),o=Math.round(o*100)/100;const a=Math.round((Number(c)-o)*100)/100;return{discount:o,finalAmount:a}},async previewPromocode(v,c,A="RUB"){this.loading=!0,this.error=null,this.preview=null;try{if(!v||typeof c>"u"){const h="code и orderAmount обязательны";return this.error=h,{success:!1,message:h,data:null}}const d=await this.getPromoByCode(v);if(!d.success)return{success:!1,message:d.message||"Промокод не найден",data:null};const o=d.data;if(Number(c)<Number(o.minimum_order_amount||0)){const h=`Минимальная сумма заказа ${o.minimum_order_amount||0}`;return this.preview=o,this.error=h,{success:!1,message:h,data:o}}const{discount:a,finalAmount:N}=this.calculateDiscountLocal(o,c);return this.preview={...o,discount:a,finalAmount:N},{success:!0,data:this.preview,discount:a,finalAmount:N}}catch(d){return console.error("previewPromocode error",d),this.error=d.message||"Ошибка превью",{success:!1,message:this.error,data:null}}finally{this.loading=!1}},async applyPromocode({code:v,uid:c,orderAmount:A,currency:d="USD",orderId:o=null}){this.loading=!0,this.error=null;try{if(!v||!c||typeof A>"u"){const R="Обязательные поля: code, uid, orderAmount";return this.error=R,{success:!1,message:R,data:null}}const a={code:v,uid:c,orderAmount:A,currency:d,orderId:o},N=await fetch(`${ie}/redeem`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(a)}),h=await N.json().catch(()=>null),g=this._extractData(h);if(!N.ok){const R=g&&(g.message||g.error)||`HTTP ${N.status}`;return this.error=R,{success:!1,message:R,data:null}}const $={...g||{},code:g&&g.code?g.code:v};return this.lastApplied=$,{success:!0,data:$}}catch(a){return console.error("applyPromocode error",a),this.error=a.message||"Ошибка при применении промокода",{success:!1,message:this.error,data:null}}finally{this.loading=!1}}}}),je={class:"buy__container"},He={class:"wrapper"},Oe={class:"card card__container"},We={class:"card__left"},Ke={class:"title"},Je={class:"extras"},Ye={class:"addon custom-switch"},Ge={class:"label-text"},Xe={class:"domain__container"},Ze={class:"domain-scroll__container"},Qe={class:"order-lines"},et={class:"line"},tt={key:0,class:"line"},rt={key:1,class:"line"},at={key:2,class:"line"},st={class:"line"},ot={key:3,class:"line discount"},lt={class:"line"},nt={class:"line",style:{"flex-direction":"column","align-items":"stretch",gap:"0.5rem","padding-top":"0.5rem"}},it={style:{display:"flex",gap:"0.5rem","align-items":"center"}},ut=["disabled"],ct=["disabled"],dt={key:0},pt={key:1},vt={key:0,class:"note",style:{color:"#b91c1c","margin-top":"0.25rem"}},ft={key:1,class:"note",style:{color:"#064e3b","margin-top":"0.25rem"}},mt={key:2,class:"note",style:{color:"#064e3b","margin-top":"0.25rem"}},yt={class:"line total"},ht={class:"order-actions"},gt={class:"input"},bt={class:"readonly-field","aria-live":"polite"},_t={class:"input"},wt={class:"readonly-field","aria-live":"polite"},Pt={class:"input"},Nt={class:"readonly-field","aria-live":"polite"},At={key:1,class:"login-row"},Ct=["disabled"],kt={class:"note","aria-live":"polite"},Mt=350,Tt={__name:"[id]",setup(v){const c=Me(),A=Te(),d=Fe(),o=xe(),a=Ve(),N=Be(),h=Re(),g=M(!1),$=M(!1),R=c.params.id;Ue(async()=>{if(R&&typeof d.getTemplateById=="function")try{await d.getTemplateById(R)}catch{}if(typeof o.init=="function")try{await o.init()}catch{}try{await k()}catch{}});function ue(){$.value=!1,g.value=!0}function ce(){$.value=!0,g.value=!0}function de(){g.value=!1}const y=M(null),U=M(null);function pe(t){if(t){typeof t=="string"?y.value={fqdn:t,price:0,price_currency:"RUB",available:!0}:y.value={fqdn:t.fqdn,price:Number(t.price||0),price_currency:t.price_currency||t.priceCurrency||"RUB",available:t.available??!0,id:t.id??t.domainId??null,raw:t};try{typeof window<"u"&&window.innerWidth<=768&&ze(()=>{setTimeout(()=>{if(U.value&&typeof U.value.scrollIntoView=="function")U.value.scrollIntoView({behavior:"smooth",block:"start"});else{const e=U.value&&U.value.$el?U.value.$el:U.value;if(e&&e.getBoundingClientRect){const s=e.getBoundingClientRect().top+window.scrollY-12;window.scrollTo({top:s,behavior:"smooth"})}}},120)})}catch{}}}const Q=l(()=>{var t;return Number(((t=y.value)==null?void 0:t.price)||0)}),D=l(()=>d.current||{id:null,title:"",price:0,discount_percent:0,discount_amount:0}),ee=l(()=>Number(D.value.price||0)),ve=l(()=>{const t=Number(D.value.discount_percent||0),e=Number(D.value.discount_amount||0);return t>0?`${t}%`:e>0?b(e):""}),n=M({extraPage:{enabled:!1,price:1e3,count:0},customization:{enabled:!1,pricePerHour:500,hours:0},priority:{enabled:!1,price:3e3},hosting:{enabled:!1,price:1e3}}),W=M({name:"",contact:""}),V=M(!1),x=M(!1),C=M(""),m=M(null),K=l(()=>(C.value||"").trim()),fe=l(()=>{const t=Number(n.value.extraPage.count||0);return n.value.extraPage.enabled&&t>0?t*Number(n.value.extraPage.price||0):0}),me=l(()=>{const t=Number(n.value.customization.hours||0);return n.value.customization.enabled&&t>0?t*Number(n.value.customization.pricePerHour||0):0}),ye=l(()=>n.value.priority.enabled?Number(n.value.priority.price||0):0),he=l(()=>n.value.hosting.enabled?Number(n.value.hosting.price||0):0),E=l(()=>[ee.value,fe.value,me.value,ye.value,he.value,Q.value].reduce((t,e)=>t+Number(e||0),0)),j=l(()=>{const t=Number(D.value.discount_amount||0),e=Number(D.value.discount_percent||0);return t>0?Math.min(t,E.value):e>0?Math.min(Math.round(E.value*e/100),E.value):0}),B=l(()=>{const t=E.value-Number(j.value||0);return t>0?t:0}),L=l(()=>!!a.preview),te=l(()=>{var t;return Number(((t=a.preview)==null?void 0:t.discount)||0)});l(()=>{var t;return Number(((t=a.preview)==null?void 0:t.finalAmount)??B.value)});const H=l(()=>{var t;return((t=a.preview)==null?void 0:t.code)||C.value}),q=l(()=>!!a.lastApplied),re=l(()=>{var t;return Number(((t=a.lastApplied)==null?void 0:t.discount)||0)}),J=l(()=>{var t;return((t=a.lastApplied)==null?void 0:t.code)||""}),ae=l(()=>{const t=Math.round(Number(re.value||0)),e=Math.round(Number(te.value||0)),s=Math.round(Number(B.value||0));return q.value?Math.min(t,s):L.value?Math.min(e,s):0}),ge=l(()=>{const t=Math.round(Number(j.value||0)),e=Math.round(ae.value||0),s=Math.round(Number(E.value||0));return Math.min(t+e,s)}),O=l(()=>{const t=Math.round(Number(B.value||0)),e=Math.round(ae.value||0),s=t-e;return s<=0?0:s>0&&s<1?1:Math.round(s)});function b(t){try{const e=Number(t||0);return new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",maximumFractionDigits:0}).format(Math.round(e))}catch{return`${t} ₽`}}I(C,()=>{m.value=null}),I(E,()=>{m.value=null});async function k(){const t=["clearPreview","clear","resetPreview","reset","clearApplied","clearAll"];for(const e of t)if(typeof a[e]=="function")try{await a[e]();return}catch{}try{"preview"in a&&(a.preview=null),"lastApplied"in a&&(a.lastApplied=null)}catch{}}function Y(){const t=o.user||{};return t.uid||t.id||t.userId||null}function z(t){if(!t)return"Ошибка при проверке промокода";const e=String(t);return/http\s*400|400/i.test(e)?"Промокод не применён — проверьте код и попробуйте снова.":/code\s+and\s+orderAmount|code и orderAmount|orderamount/i.test(e)?"Невозможно проверить промокод: сумма заказа не указана.":e.length<140?e:"Невозможно проверить промокод"}async function se(){m.value=null;const t=K.value;if(!t){m.value="Введите код промокода";return}const e=Math.round(Number(B.value||0));if(e<=0){m.value="Сумма для промокода равна нулю. Добавьте домен или опции.";return}x.value=!0;try{typeof a.clearError=="function"&&a.clearError(),typeof a.clearPreview=="function"?await a.clearPreview():a.preview=null;const s=await a.previewPromocode(t,e,"RUB");if(!s||s.success===!1){m.value=z(s==null?void 0:s.message);return}m.value=null}catch(s){console.error("onApplyPromo error",s),m.value=z((s==null?void 0:s.message)||s)}finally{x.value=!1}}async function be(){if(!L.value||q.value)return{success:!0};const t=(H.value||C.value||"").trim();if(!t){try{await k()}catch{}return{success:!0}}const e=Y();if(!e){try{await k()}catch{}return{success:!0}}x.value=!0;try{typeof a.clearError=="function"&&a.clearError();const s=Math.round(Number(B.value||0)),i=await a.applyPromocode({code:t,uid:e,orderAmount:s,currency:"RUB"});if(i&&(i.success===!0||i.data))return{success:!0};const p=(i==null?void 0:i.message)||i&&i.data&&(i.data.message||i.data.error)||null,f=z(p);try{await k()}catch{}return{success:!0,message:f}}catch(s){console.error("_ensurePromoAppliedBeforeOrder error",s);try{await k()}catch{}return{success:!0,message:"Ошибка при применении промокода"}}finally{x.value=!1}}async function _e(){const t=["consumeApplied","consumePromocode","clearApplied","resetApplied","clearPreview","reset","clear","finalizePromo"];for(const e of t)if(typeof a[e]=="function")try{await a[e]();return}catch{}}const F=l(()=>!!o.isAuthenticated),G=l(()=>o.user||{}),we=l(()=>F.value&&!!y.value&&!!y.value.fqdn);I(F,t=>{if(t){const e=o.user||{};e.name&&(W.value.name=e.name),e.email&&(W.value.contact=e.email)}});let _=null;async function oe(){const t=L.value,e=q.value,s=(H.value||C.value||J.value||"").trim();if(!s||!t&&!e){try{await k()}catch{}return}const i=Math.round(Number(B.value||0));if(i<=0){try{await k()}catch{}return}x.value=!0;try{if(e){const p=Y();if(!p){try{await k()}catch{}return}typeof a.clearError=="function"&&a.clearError();const f=await a.applyPromocode({code:s,uid:p,orderAmount:i,currency:"RUB"});if(!f||f.success===!1){try{await k()}catch{}const X=z((f==null?void 0:f.message)||f&&f.data&&(f.data.message||f.data.error));m.value=X}else m.value=null;return}if(t){typeof a.clearError=="function"&&a.clearError();const p=await a.previewPromocode(s,i,"RUB");if(!p||p.success===!1){try{await k()}catch{}m.value=z(p==null?void 0:p.message)}else m.value=null}}catch(p){console.error("_refreshPromoAfterPriceChange error",p),m.value=z((p==null?void 0:p.message)||p)}finally{x.value=!1}}I(()=>Math.round(Number(B.value||0)),()=>{_&&(clearTimeout(_),_=null),_=setTimeout(()=>{oe().catch(t=>{console.error(t)}),_=null},Mt)}),I(F,t=>{t&&L.value&&K.value&&(_&&(clearTimeout(_),_=null),_=setTimeout(()=>{oe().catch(e=>console.error(e)),_=null},120))}),De(()=>{_&&(clearTimeout(_),_=null)});async function Pe(){var t;if(!F.value){A.push({path:"/login"});return}if(!y.value){h.showAlert({title:"Выберите домен",message:"Пожалуйста, выберите домен перед оформлением заказа.",type:"warning",typeClass:"alert-warning",background:"#fff3cd",color:"#856404",autoClose:{enabled:!0,delay:4e3}});return}V.value=!0;try{const e=await be();e&&e.message&&h.showAlert({title:"Промокод",message:e.message,type:"warning",typeClass:"alert-warning",background:"#fff3cd",color:"#856404",autoClose:{enabled:!0,delay:5e3}});const s={templateId:D.value.id,price:O.value,paymentMethod:"balance",domain:{fqdn:y.value.fqdn,price:Number(y.value.price||0),currency:y.value.price_currency||"RUB",available:!!y.value.available,id:y.value.id??null}};if(q.value||L.value){const f=J.value||H.value||C.value.trim();s.external={promocode:f||null,total_price:Math.round(Number(B.value||0)),price:O.value,discount:ge.value,user_uid:Y()},a.lastApplied&&a.lastApplied.redemptionId&&(s.external.uid=a.lastApplied.redemptionId)}const i=await N.createOrder(s);if(!i||i.success===!1){const f=i&&i.message?i.message:"Не удалось создать заказ";h.showAlert({title:"Ошибка",message:f,type:"error",typeClass:"alert-error",background:"#f8d7da",color:"#721c24",autoClose:{enabled:!0,delay:6e3}});return}h.showAlert({title:"Заявка отправлена",message:`Итог: ${b(O.value)}`,type:"success",typeClass:"alert-success",background:"#d4edda",color:"#155724",autoClose:{enabled:!0,delay:4e3}});try{await((t=N.fetchUserOrders)==null?void 0:t.call(N,{page:1,perPage:20}))}catch{}await _e(),await Ne();const p=i.data;if(p&&p.id)try{A.push({path:"/profile",query:{tab:"orders"}})}catch{}}catch(e){console.error(e),h.showAlert({title:"Ошибка",message:e&&e.message?e.message:"Ошибка при оформлении заказа",type:"error",typeClass:"alert-error",background:"#f8d7da",color:"#721c24",autoClose:{enabled:!0,delay:5e3}})}finally{V.value=!1}}async function Ne(){n.value.extraPage.enabled=!1,n.value.extraPage.count=0,n.value.customization.enabled=!1,n.value.customization.hours=0,n.value.priority.enabled=!1,n.value.hosting.enabled=!1,W.value={name:"",contact:""},y.value=null;const t=["clearPreview","clearApplied","resetApplied","reset","clear"];for(const e of t)if(typeof a[e]=="function")try{await a[e]();break}catch{}C.value="",m.value=null}return(t,e)=>(P(),w("div",je,[r("div",He,[r("section",Oe,[r("div",We,[r("h1",Ke,'Сайт "'+u(D.value.title)+'"',1),e[6]||(e[6]=r("h3",{class:"card__h3"},"Дополнительные опции",-1)),r("div",Je,[r("label",Ye,[ne(r("input",{type:"checkbox","onUpdate:modelValue":e[0]||(e[0]=s=>n.value.priority.enabled=s)},null,512),[[Ee,n.value.priority.enabled]]),e[5]||(e[5]=r("span",{class:"switch-track","aria-hidden":""},[r("span",{class:"switch-thumb"})],-1)),r("span",Ge,"Приоритетная доработка — "+u(b(n.value.priority.price)),1)])]),e[7]||(e[7]=r("h3",{class:"card__h3 domain__h3"},"Выберите домен",-1)),r("div",Xe,[r("div",Ze,[le(Ie,{onSelectDomain:pe})])])])]),r("aside",{ref_key:"sidebarRef",ref:U,class:"card sidebar"},[e[24]||(e[24]=r("h2",null,"Ваш заказ",-1)),r("div",Qe,[r("div",et,[e[8]||(e[8]=r("span",null,"Базовая цена",-1)),r("span",null,u(b(ee.value)),1)]),n.value.priority.enabled?(P(),w("div",tt,[e[9]||(e[9]=r("span",null,"Приоритет",-1)),r("span",null,u(b(n.value.priority.price)),1)])):S("",!0),n.value.hosting.enabled?(P(),w("div",rt,[e[10]||(e[10]=r("span",null,"Подключение / хостинг",-1)),r("span",null,u(b(n.value.hosting.price)),1)])):S("",!0),y.value?(P(),w("div",at,[r("span",null,"Домен ("+u(y.value.fqdn)+")",1),r("span",null,u(b(Q.value)),1)])):S("",!0),e[15]||(e[15]=r("hr",null,null,-1)),r("div",st,[e[11]||(e[11]=r("strong",null,"Промежуточная сумма",-1)),r("strong",null,u(b(E.value)),1)]),j.value>0?(P(),w("div",ot,[r("span",null,"Скидка шаблона "+u(ve.value),1),r("span",null,"-"+u(b(j.value)),1)])):S("",!0),r("div",lt,[e[12]||(e[12]=r("strong",null,"Сумма после скидки шаблона",-1)),r("strong",null,u(b(B.value)),1)]),r("div",nt,[r("div",it,[ne(r("input",{"onUpdate:modelValue":e[1]||(e[1]=s=>C.value=s),onKeyup:$e(se,["enter"]),disabled:Z(a).loading||x.value,placeholder:"Введите промокод",class:"promocode__input",style:{flex:"1"},"aria-label":"Промокод"},null,40,ut),[[Se,C.value]]),r("button",{class:"btn primary",onClick:se,disabled:Z(a).loading||x.value||!K.value,title:"Проверить и применить промокод"},[x.value?(P(),w("span",pt,"Применяется…")):(P(),w("span",dt,u(Z(a).loading?"Обработка…":"Применить"),1))],8,ct)]),e[13]||(e[13]=r("div",{class:"note",style:{"margin-top":"0.25rem"}},[T("Промокод применяется к сумме "),r("strong",null,"после"),T(" скидки шаблона.")],-1)),m.value?(P(),w("div",vt,u(m.value),1)):S("",!0),L.value&&!q.value?(P(),w("div",ft," Промокод применен«"+u(H.value||C.value)+"»: скидка составила "+u(b(te.value)),1)):S("",!0),q.value?(P(),w("div",mt," Промокод «"+u(J.value)+"» применён — скидка "+u(b(re.value))+". ",1)):S("",!0)]),r("div",yt,[e[14]||(e[14]=r("strong",null,"Итого к оплате",-1)),r("strong",null,u(b(O.value)),1)])]),r("div",ht,[F.value?(P(),w(Le,{key:0},[r("label",gt,[e[16]||(e[16]=T(" ФИО: ")),r("div",bt,u(G.value.fullname||"—"),1)]),r("label",_t,[e[17]||(e[17]=T(" Телефон: ")),r("div",wt,u(G.value.phone||"—"),1)]),r("label",Pt,[e[18]||(e[18]=T(" Почта: ")),r("div",Nt,u(G.value.email||"—"),1)])],64)):(P(),w("div",At,[e[19]||(e[19]=T(" Необходимо ")),r("button",{class:"btn-link",onClick:ue},"Войти"),e[20]||(e[20]=T(" или ")),r("button",{class:"btn-link",onClick:ce},"Зарегистрироваться")])),r("button",{class:"btn primary",disabled:V.value||!we.value,onClick:Pe},u(V.value?"Оформление…":"Оформить заказ"),9,Ct),r("div",kt,[r("small",null,[e[21]||(e[21]=T(" Нажимая «Оформить заказ», вы соглашаетесь с ")),r("a",{onClick:e[2]||(e[2]=s=>t.openInNewTab("/terms"))},"условиями оферты"),e[22]||(e[22]=T(" и ")),r("a",{onClick:e[3]||(e[3]=s=>t.openInNewTab("/privacy"))},"политикой конфиденциальности"),e[23]||(e[23]=T(". "))])])])],512)]),le(qe,{visible:g.value,"onUpdate:visible":e[4]||(e[4]=s=>g.value=s),onLogin:de,startWithRegister:$.value},null,8,["visible","startWithRegister"])]))}},Dt=ke(Tt,[["__scopeId","data-v-29e93d81"]]);export{Dt as default};
