import{h as Pe,A as Ae,_ as Ne,L as Ce,K as ke,J as xe,D as De,C as Se,k as N,l as Me,E as o,M as K,c as m,o as f,a as s,b as se,t as i,i as ae,X as Ue,f as C,v as Be,y as W,P as Te,F as $e,d as D,Z as Re}from"./iHL_0Qvu.js";import{u as Ee}from"./C6vWwSvJ.js";import{D as qe}from"./DPzYreY9.js";const re=`${Ae.fullUrl}/promocode`,Le=Pe("promocodes",{state:()=>({loading:!1,error:null,lastApplied:null,preview:null}),actions:{clearError(){this.error=null},reset(){this.loading=!1,this.error=null,this.lastApplied=null,this.preview=null},_extractData(p){return p?p.data??p:null},async getPromoByCode(p){this.loading=!0,this.error=null;try{if(!p)return{success:!1,message:"code is required",data:null};const c=await fetch(`${re}/by-code/${encodeURIComponent(p)}`,{method:"GET",headers:{Accept:"application/json"}}),w=await c.json().catch(()=>null),d=this._extractData(w);if(!c.ok){const l=d&&(d.message||d.error)||`HTTP ${c.status}`;return this.error=l,{success:!1,message:d.data,data:null}}return{success:!0,data:d}}catch(c){return console.error("getPromoByCode error",c),this.error=c.message||"Network error",{success:!1,message:this.error,data:null}}finally{this.loading=!1}},calculateDiscountLocal(p,c){if(!p)return{discount:0,finalAmount:Number(c)};const w=(p.discount_type||"").toLowerCase(),d=Number(p.discount_value||0);let l=0;w==="percent"?l=Number(c)*d/100:l=d,l>Number(c)&&(l=Number(c)),l=Math.round(l*100)/100;const a=Math.round((Number(c)-l)*100)/100;return{discount:l,finalAmount:a}},async previewPromocode(p,c,w="RUB"){this.loading=!0,this.error=null,this.preview=null;try{if(!p||typeof c>"u"){const y="code и orderAmount обязательны";return this.error=y,{success:!1,message:y,data:null}}const d=await this.getPromoByCode(p);if(!d.success)return{success:!1,message:d.message||"Промокод не найден",data:null};const l=d.data;if(Number(c)<Number(l.minimum_order_amount||0)){const y=`Минимальная сумма заказа ${l.minimum_order_amount||0}`;return this.preview=l,this.error=y,{success:!1,message:y,data:l}}const{discount:a,finalAmount:P}=this.calculateDiscountLocal(l,c);return this.preview={...l,discount:a,finalAmount:P},{success:!0,data:this.preview,discount:a,finalAmount:P}}catch(d){return console.error("previewPromocode error",d),this.error=d.message||"Ошибка превью",{success:!1,message:this.error,data:null}}finally{this.loading=!1}},async applyPromocode({code:p,uid:c,orderAmount:w,currency:d="USD",orderId:l=null}){this.loading=!0,this.error=null;try{if(!p||!c||typeof w>"u"){const k="Обязательные поля: code, uid, orderAmount";return this.error=k,{success:!1,message:k,data:null}}const a={code:p,uid:c,orderAmount:w,currency:d,orderId:l},P=await fetch(`${re}/redeem`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(a)}),y=await P.json().catch(()=>null),h=this._extractData(y);if(!P.ok){const k=h&&(h.message||h.error)||`HTTP ${P.status}`;return this.error=k,{success:!1,message:k,data:null}}const U={...h||{},code:h&&h.code?h.code:p};return this.lastApplied=U,{success:!0,data:U}}catch(a){return console.error("applyPromocode error",a),this.error=a.message||"Ошибка при применении промокода",{success:!1,message:this.error,data:null}}finally{this.loading=!1}}}}),ze={class:"buy__container"},Fe={class:"wrapper"},je={class:"card card__container"},Ve={class:"card__left"},He={class:"title"},Ie={class:"extras"},Ke={class:"addon custom-switch"},We={class:"label-text"},Je={class:"domain__container"},Ge={class:"domain-scroll__container"},Xe={class:"card sidebar"},Ze={class:"order-lines"},Oe={class:"line"},Qe={key:0,class:"line"},Ye={key:1,class:"line"},et={key:2,class:"line"},tt={class:"line"},st={class:"line",style:{"flex-direction":"column","align-items":"stretch",gap:"0.5rem","padding-top":"0.5rem"}},at={style:{display:"flex",gap:"0.5rem","align-items":"center"}},rt=["disabled"],lt=["disabled"],nt={key:0},ot={key:1},it={key:0,class:"note",style:{color:"#b91c1c","margin-top":"0.25rem"}},ut={key:1,class:"note",style:{color:"#064e3b","margin-top":"0.25rem"}},ct={key:3,class:"line discount"},dt={key:4,class:"line discount"},pt={key:5,class:"line discount"},vt={key:6,class:"line"},mt={style:{display:"flex",gap:"0.5rem","align-items":"center"}},ft={class:"line total"},yt={class:"order-actions"},ht={class:"input"},gt={class:"readonly-field","aria-live":"polite"},bt={class:"input"},_t={class:"readonly-field","aria-live":"polite"},wt={class:"input"},Pt={class:"readonly-field","aria-live":"polite"},At={key:1,class:"login-row"},Nt=["disabled"],Ct={class:"note","aria-live":"polite"},kt={__name:"[id]",setup(p){const c=Ce(),w=ke(),d=Ee(),l=xe(),a=Le(),P=De(),y=Se(),h=N(!1),U=N(!1),k=c.params.id;Me(async()=>{if(k)try{await d.getTemplateById(k)}catch{}if(typeof l.init=="function")try{await l.init()}catch{}try{await T()}catch{}});function le(){U.value=!1,h.value=!0}function ne(){U.value=!0,h.value=!0}function oe(e){h.value=!1}const v=N(null);function ie(e){e&&(typeof e=="string"?v.value={fqdn:e,price:0,price_currency:"RUB",available:!0}:typeof e=="object"&&(v.value={fqdn:e.fqdn,price:e.price??0,price_currency:e.price_currency??e.priceCurrency??"RUB",available:e.available,id:e.id??e.domainId??null,raw:e}))}function ue(){v.value=null}const J=o(()=>{var e;return Number(((e=v.value)==null?void 0:e.price)||0)}),S=o(()=>d.current||{id:null,title:"",price:0,image:"",description:"",pages:[],preview:"",discount_percent:0,discount_amount:0}),G=o(()=>Number(S.value.price||0)),u=N({extraPage:{enabled:!1,price:1e3,count:0},customization:{enabled:!1,pricePerHour:500,hours:0},priority:{enabled:!1,price:3e3},hosting:{enabled:!1,price:1e3}}),L=N({name:"",contact:""}),$=N(!1),M=N(!1),X=o(()=>(A.value||"").trim()),ce=o(()=>{const e=Number(u.value.extraPage.count||0),t=Number(u.value.extraPage.price||0);return u.value.extraPage.enabled&&e>0?e*t:0}),de=o(()=>{const e=Number(u.value.customization.hours||0),t=Number(u.value.customization.pricePerHour||0);return u.value.customization.enabled&&e>0?e*t:0}),pe=o(()=>u.value.priority.enabled?Number(u.value.priority.price||0):0),ve=o(()=>u.value.hosting.enabled?Number(u.value.hosting.price||0):0),g=o(()=>[G.value,ce.value,de.value,pe.value,ve.value,J.value].reduce((t,r)=>t+Number(r||0),0)),z=o(()=>{const e=Number(S.value.discount_amount||0),t=Number(S.value.discount_percent||0);return e>0?Math.min(e,g.value):t>0?Math.min(Math.round(g.value*t/100),g.value):0}),me=o(()=>{const e=Number(S.value.discount_amount||0),t=Number(S.value.discount_percent||0);return e>0?`${b(e)}`:t>0?`${t}%`:""}),R=o(()=>!!a.preview),Z=o(()=>{var e;return Number(((e=a.preview)==null?void 0:e.discount)||0)});o(()=>{var e;return Number(((e=a.preview)==null?void 0:e.finalAmount)??g.value)});const F=o(()=>{var e;return((e=a.preview)==null?void 0:e.code)||A.value}),B=o(()=>!!a.lastApplied),j=o(()=>{var e;return Number(((e=a.lastApplied)==null?void 0:e.discount)||0)}),V=o(()=>{var e;return((e=a.lastApplied)==null?void 0:e.code)||""}),fe=o(()=>{const e=Number(j.value||0),t=Number(Z.value||0);return B.value?Math.min(e,g.value):R.value?Math.min(t,g.value):0}),O=o(()=>{const e=Number(z.value||0),t=fe.value||0;return Math.min(e+t,g.value)}),E=o(()=>{const e=g.value-O.value;return e>0?Math.round(e):0});function b(e){try{const t=Number(e||0);return new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",maximumFractionDigits:0}).format(Math.round(t))}catch{return`${e} ₽`}}const A=N(""),_=N(null);K(A,()=>{_.value=null}),K(g,()=>{_.value=null});async function T(){const e=["clearPreview","clear","resetPreview","reset","clearApplied","clearAll"];for(const t of e)if(typeof a[t]=="function")try{await a[t]();return}catch{}try{"preview"in a&&(a.preview=null),"lastApplied"in a&&(a.lastApplied=null)}catch{}}function Q(){const e=l.user||{};return e.uid||e.id||e.userId||null}function H(e){if(!e)return"Ошибка при проверке промокода";const t=String(e);return/http\s*400|400/i.test(t)?"Промокод не применён — проверьте код и попробуйте снова.":/code\s+and\s+orderAmount|code и orderAmount|orderamount/i.test(t)?"Невозможно проверить промокод: сумма заказа не указана. Пожалуйста, выберите домен/товары.":t.length<140?t:"Невозможно проверить промокод"}async function Y(e){_.value=null;const t=X.value;if(!t){_.value="Введите код промокода";return}const r=Math.round(Number(g.value||0));if(r<=0){_.value="Выберите домен или добавьте опции, чтобы проверить промокод.";return}M.value=!0;try{typeof a.clearError=="function"&&a.clearError(),typeof a.clearPreview=="function"?a.clearPreview():a.preview=null;const n=await a.previewPromocode(t,r,"RUB");if(!n||n.success===!1){_.value=H(n==null?void 0:n.message);return}_.value=null}catch(n){console.error("onApplyPromo error",n),_.value=H((n==null?void 0:n.message)||n)}finally{M.value=!1}}async function ye(){if(!R.value||B.value)return{success:!0};const e=(F.value||A.value||"").trim();if(!e){try{await T()}catch{}return{success:!0}}const t=Q();if(!t){try{await T()}catch{}return{success:!0}}M.value=!0;try{typeof a.clearError=="function"&&a.clearError();const r=Math.round(Number(g.value||0)),n=await a.applyPromocode({code:e,uid:t,orderAmount:r,currency:"RUB"});if(n&&(n.success===!0||n.data))return{success:!0};const x=(n==null?void 0:n.message)||n&&n.data&&(n.data.message||n.data.error)||null,we=H(x);try{await T()}catch{}return{success:!0,message:we}}catch(r){console.error("_ensurePromoAppliedBeforeOrder error",r);try{await T()}catch{}return{success:!0,message:"Ошибка при применении промокода"}}finally{M.value=!1}}async function he(){const e=["consumeApplied","consumePromocode","clearApplied","resetApplied","clearPreview","reset","clear","finalizePromo"];for(const t of e)if(typeof a[t]=="function")try{await a[t]();return}catch{}}const q=o(()=>!!l.isAuthenticated),ee=o(()=>{const e=l.user||{};if(e.name)return e.name;const t=e.firstName||e.first_name||"",r=e.lastName||e.last_name||"";return`${t} ${r}`.trim()||""}),te=o(()=>{const e=l.user||{};return e.email||e.email_address||e.phone||""}),I=o(()=>l.user||{}),ge=o(()=>q.value&&!!v.value&&!!v.value.fqdn);K(q,e=>{e&&(ee.value&&(L.value.name=ee.value),te.value&&(L.value.contact=te.value))});async function be(){if(!q.value){w.push({path:"/login"});return}if(!v.value){y.showAlert({title:"Выберите домен",message:"Пожалуйста, выберите домен перед оформлением заказа.",type:"warning",typeClass:"alert-warning",background:"#fff3cd",color:"#856404",autoClose:{enabled:!0,delay:4e3}});return}$.value=!0;try{const e=await ye();e&&e.message&&y.showAlert({title:"Промокод",message:e.message,type:"warning",typeClass:"alert-warning",background:"#fff3cd",color:"#856404",autoClose:{enabled:!0,delay:5e3}});const t={templateId:S.value.id,price:E.value,paymentMethod:"balance",domain:{fqdn:v.value.fqdn,price:Number(v.value.price||0),currency:v.value.price_currency||v.value.priceCurrency||"RUB",available:!!v.value.available,id:v.value.id??null}};if(B.value||R.value){const x=V.value||F.value||A.value.trim();t.external={promocode:x||null,total_price:g.value,price:E.value,discount:O.value,user_uid:Q()},a.lastApplied&&a.lastApplied.redemptionId&&(t.external.uid=a.lastApplied.redemptionId)}const r=await P.createOrder(t);if(!r||r.success===!1){const x=r&&r.message?r.message:"Не удалось создать заказ";y.showAlert({title:"Ошибка",message:x,type:"error",typeClass:"alert-error",background:"#f8d7da",color:"#721c24",autoClose:{enabled:!0,delay:6e3}});return}const n=r.data;y.showAlert({title:"Заявка отправлена",message:`Итог: ${b(E.value)}`,type:"success",typeClass:"alert-success",background:"#d4edda",color:"#155724",autoClose:{enabled:!0,delay:4e3}});try{await P.fetchUserOrders({page:1,perPage:20})}catch(x){console.log(x,"error")}if(await he(),await _e(),n&&n.id)try{w.push({path:"/profile",query:{tab:"orders"}})}catch{}}catch(e){console.error(e),y.showAlert({title:"Ошибка",message:e&&e.message?e.message:"Ошибка при оформлении заказа",type:"error",typeClass:"alert-error",background:"#f8d7da",color:"#721c24",autoClose:{enabled:!0,delay:5e3}})}finally{$.value=!1}}async function _e(){u.value.extraPage.enabled=!1,u.value.extraPage.count=0,u.value.customization.enabled=!1,u.value.customization.hours=0,u.value.priority.enabled=!1,u.value.hosting.enabled=!1,L.value={name:"",contact:""},v.value=null;const e=["clearPreview","clearApplied","resetApplied","reset","clear"];for(const t of e)if(typeof a[t]=="function")try{await a[t]();break}catch{}A.value="",_.value=null}return(e,t)=>(f(),m("div",ze,[s("div",Fe,[s("section",je,[s("div",Ve,[s("h1",He,'Сайт "'+i(S.value.title)+'"',1),t[6]||(t[6]=s("h3",{class:"card__h3"},"Дополнительные опции",-1)),s("div",Ie,[s("label",Ke,[ae(s("input",{type:"checkbox","onUpdate:modelValue":t[0]||(t[0]=r=>u.value.priority.enabled=r)},null,512),[[Ue,u.value.priority.enabled]]),t[5]||(t[5]=s("span",{class:"switch-track","aria-hidden":""},[s("span",{class:"switch-thumb"})],-1)),s("span",We,"Приоритетная доработка — "+i(b(u.value.priority.price)),1)])]),t[7]||(t[7]=s("h3",{class:"card__h3 domain__h3"},"Выберите домен",-1)),s("div",Je,[s("div",Ge,[se(qe,{onSelectDomain:ie})])])])]),s("aside",Xe,[t[23]||(t[23]=s("h2",null,"Ваш заказ",-1)),s("div",Ze,[s("div",Oe,[t[8]||(t[8]=s("span",null,"Базовая цена",-1)),s("span",null,i(b(G.value)),1)]),u.value.priority.enabled?(f(),m("div",Qe,[t[9]||(t[9]=s("span",null,"Приоритет",-1)),s("span",null,i(b(u.value.priority.price)),1)])):C("",!0),u.value.hosting.enabled?(f(),m("div",Ye,[t[10]||(t[10]=s("span",null,"Подключение / хостинг",-1)),s("span",null,i(b(u.value.hosting.price)),1)])):C("",!0),v.value?(f(),m("div",et,[s("span",null,"Домен ("+i(v.value.fqdn)+")",1),s("span",null,i(b(J.value)),1)])):C("",!0),t[14]||(t[14]=s("hr",null,null,-1)),s("div",tt,[t[11]||(t[11]=s("strong",null,"Промежуточная сумма",-1)),s("strong",null,i(b(g.value)),1)]),s("div",st,[s("div",at,[ae(s("input",{"onUpdate:modelValue":t[1]||(t[1]=r=>A.value=r),onKeyup:Te(Y,["enter"]),disabled:W(a).loading||M.value,placeholder:"Введите промокод",class:"promocode__input",style:{flex:"1"},"aria-label":"Промокод"},null,40,rt),[[Be,A.value]]),s("button",{class:"btn primary",onClick:Y,disabled:W(a).loading||M.value||!X.value,title:"Нажмите, чтобы проверить и применить промокод"},[M.value?(f(),m("span",ot,"Применяется…")):(f(),m("span",nt,i(W(a).loading?"Обработка…":"Применить"),1))],8,lt)]),_.value?(f(),m("div",it,i(_.value),1)):C("",!0),B.value?(f(),m("div",ut," Промокод «"+i(V.value)+"» успешно применён — скидка "+i(b(j.value))+". ",1)):C("",!0)]),R.value&&!B.value?(f(),m("div",ct,[s("span",null,"Промокод: "+i(F.value||A.value),1),s("span",null,"-"+i(b(Z.value)),1)])):C("",!0),B.value?(f(),m("div",dt,[s("span",null,"Промокод: "+i(V.value),1),s("span",null,"-"+i(b(j.value)),1)])):C("",!0),z.value>0?(f(),m("div",pt,[s("span",null,"Скидка шаблона "+i(me.value),1),s("span",null,"-"+i(b(z.value)),1)])):C("",!0),v.value?(f(),m("div",vt,[t[12]||(t[12]=s("span",null,"Выбран домен",-1)),s("span",mt,[s("strong",null,i(v.value.fqdn),1),s("button",{class:"btn ghost",onClick:ue,title:"Сбросить выбор домена"},"Сбросить")])])):C("",!0),s("div",ft,[t[13]||(t[13]=s("strong",null,"Итого",-1)),s("strong",null,i(b(E.value)),1)])]),s("div",yt,[q.value?(f(),m($e,{key:0},[s("label",ht,[t[15]||(t[15]=D(" ФИО: ")),s("div",gt,i(I.value.fullname||"—"),1)]),s("label",bt,[t[16]||(t[16]=D(" Телефон: ")),s("div",_t,i(I.value.phone||"—"),1)]),s("label",wt,[t[17]||(t[17]=D(" Почта: ")),s("div",Pt,i(I.value.email||"—"),1)])],64)):(f(),m("div",At,[t[18]||(t[18]=D(" Необходимо ")),s("button",{class:"btn-link",onClick:le},"Войти"),t[19]||(t[19]=D(" или ")),s("button",{class:"btn-link",onClick:ne},"Зарегистрироваться")])),s("button",{class:"btn primary",disabled:$.value||!ge.value,onClick:be},i($.value?"Оформление…":"Оформить заказ"),9,Nt),s("div",Ct,[s("small",null,[t[20]||(t[20]=D(" Нажимая «Оформить заказ», вы соглашаетесь с ")),s("a",{onClick:t[2]||(t[2]=r=>e.openInNewTab("/terms"))},"условиями оферты"),t[21]||(t[21]=D(" и ")),s("a",{onClick:t[3]||(t[3]=r=>e.openInNewTab("/privacy"))},"политикой конфиденциальности"),t[22]||(t[22]=D(". "))])])])])]),se(Re,{visible:h.value,"onUpdate:visible":t[4]||(t[4]=r=>h.value=r),onLogin:oe,startWithRegister:U.value},null,8,["visible","startWithRegister"])]))}},Ut=Ne(kt,[["__scopeId","data-v-c59628c8"]]);export{Ut as default};
